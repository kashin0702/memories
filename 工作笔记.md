

### 全局请求方法get/post

登陆接口以后返回的**authKey**和**sessionId** 存入缓存中

各个请求均需要添加到header中

```js
//get请求
_get(url, data, success, fail, complete, check_login) {
    wx.showNavigationBarLoading();
    let _this = this;
    // 构造请求参数
    data = data || {};
    // data.wxapp_id = _this.getWxappId();

    // 构造get请求
    let request = function() {
      let authKey = wx.getStorageSync('authKey');
      let sessionId = wx.getStorageSync('sessionId');
      wx.request({
        url: _this.api_root + url,
        header: {
          'content-type': 'application/json',
          'authKey': authKey,     
          'sessionId': sessionId,
        },
        data: data,
        success(res) {
          if (res.data.code !== 200 || typeof res.data !== 'object') {
            if (res.data.code == 101) {
              wx.showToast({
                title: res.error || res.data.error || '请重新登录',
                icon: 'none',
                duration: 2000
              })
              wx.clearStorageSync();
              setTimeout(() => {
                wx.reLaunch({
                  url: '/pages/auth/auth'
                })
              }, 2000)
              return false
            }
            _this.showError(res.data.error);
            return false;
          }
          success && success(res.data);
        },
        fail(res) {
          _this.showError(res.errMsg, function() {
            fail && fail(res);
          });
        },
        complete(res) {
          wx.hideNavigationBarLoading();
          complete && complete(res);
        },
      });
    };
    // 判断是否需要验证登录
    check_login ? _this.doLogin(request) : request();
  }


//post请求
_post_form(url, data, success, fail, complete, isShowNavBarLoading) {
    let _this = this;
    let header;
    isShowNavBarLoading || true;
    let authKey = wx.getStorageSync('authKey');
    let sessionId = wx.getStorageSync('sessionId');
    header = {
      'content-type': 'application/x-www-form-urlencoded',
      'authKey': authKey,
      'sessionId': sessionId,
    }
    // 在当前页面显示导航条加载动画
    if (isShowNavBarLoading == true) {
      wx.showNavigationBarLoading();
    }
    wx.request({
      url: _this.api_root + url,
      header: header,
      method: 'POST',
      data: data,
      success(res) {
        if (res.data.code !== 200 || typeof res.data !== 'object') {
          if (res.data.code == 101) {
            wx.showToast({
              title: res.error || res.data.error || '请重新登录',
              icon: 'none',
              duration: 2000
            })
            wx.clearStorageSync();
            setTimeout(() => {
              wx.reLaunch({
                url: '/pages/auth/auth'
              })
            }, 2000)
            return false
          }
          _this.showError(res.data.error);
          return false;
        }
        success && success(res.data);
      },
      fail(res) {
        // console.log(res);
        _this.showError(res.errMsg, function() {
          fail && fail(res);
        });
      },
      complete(res) {
        wx.hideNavigationBarLoading();
        // wx.hideLoading();
        complete && complete(res);
      }
    });
  }


```



### 弹窗图层周围的背景样式

```html
<!-- 一个背景容器控制所有弹窗 -->
<view class="mask" wx:if="{{successPop ||successPop2 ||  confirmPop || infosPop || show || isphonePop || isPopNum || tipsPop}}" catchtap="handleClose"></view>
```

```css
.mask {
  position: fixed;
  top: 0rpx;
  left: 0rpx;
  width: 750rpx;
  height: 100vh;
  background: rgba(0, 0, 0, 0.5);
  content: '';
  z-index: 99;
  display: block;
}
```



### PhotoShop相关

调出辅助线： ctrl + r

改图片饱和度:  顶层工具栏图像-调整-自然饱和度，记得右侧图层要合并或者选智能对象



### 已完成试卷接口

发送message_id给后台

后台返回一个link 带student_id 查看试卷结果

返回的options内是选项，先转成数组 通过和



### 后台相关

搜索思路

1. 传keywords 给接口  入参： page, pagesize , keywords
   2.拿到返回结果
   3.把数据填充回el-table


下拉列表门店名称： shopStore



接口admin/reserve/query

根据进行中/已完成   按时间段返回数据

![image-20210421140842079](C:\Users\HP ProDesk\AppData\Roaming\Typora\typora-user-images\image-20210421140842079.png)

```js
//定义一个方法，去拿表格里所有的数据 current-change
//核心方法 每次触发改变时都调用这个方法
getTable(shop) { //shop是一个 query入参对象
      this.isTableLoading = true;
      console.log("去拿表格");
      console.log(shop);
      this.apiGet("admin/reserve/query", { params: shop }).then((res) => {
        console.log(res);
        this.isTableLoading = false;
        let arr = [];
        if (res.code == 200) {
          if (this.shop.data_type == "ongoing") { //请求进行中的数据
            arr = [].concat(...Object.values(res.data));//解构数据value变成数组
          } else { //若请求的是已完成订单
            arr = res.data.rows;  //直接拿rows数组赋值给arr 
            this.shopTotal = parseInt(res.data.total); //获取数据条数 绑定给UI分页器显示
          }
          arr.map((v) => {
            v.create_time = timestampToTime(v.create_time); //转化时间
          });
          this.shopTable = arr;  //把数值保存在本地data  shopTable
        } else {
          this.$message.error(res.error);
          this.shopTable = [];
        }
      });
    },
        
        
 //拿所有门店数据 注意是门店
 //mounted 页面初始化 调用了this.getStore()
   getStore() {
      this.shopLoad = false;
      this.apiGet("admin/store/query", {
        params: { page: 1, pagesize: 100000 },
      }).then((res) => {
        this.shopLoad = true;
          //shop: { page: 1, pagesize: 10, data_type: "ongoing" },
        let shop = this.shop;
        if (res.code == 200) {
          let arr = [{ id: "", name: "全部门店" }].concat(res.data.rows);
          shop.store_id = arr[0].id + "";
          this.shopStore = arr;
          this.shop = shop;
          this.shop_id = arr[0].id;  //第一个id
          this.shop_name = arr[0].name;  //数组第一个店名
          this.getTable(shop);  //这里调了getTable 拿所有数据
        } else {
          this.$message.error("请求失败");
        }
      });
    },
```





### 预约相关

```js
//本地data
form: {
    remark: '',     //备注
    seat_category_name: '', //座位名称
    people: '',       //就餐人数
    seat_category_id: ''  //座位id
}
//选择就餐人数
handleNum(e){
    let form = this.data.form
    form.user_num = e.currentTarget.dataset.item
    this.setData{{
        form: form
    }}
    if(this.data.time && this.data.date){
        this.setData({ isDisabled: false})
    }
}
//选择人数时触发， 就餐人数
changePeople(e){
    let people = e.currentTarget.dataset.people; //获取人数
    let form = this.data.form   //创建form对象
	form.seat_category_name = ''  //座位名字
    form.seat_category_id = '' 		//座位id
    form.reserve_time = ''  	//预约时间
    form.people = people   		//就餐人数
    
    let showSeats = this.data.seatCategoryList || []  //获取座位类型的数组
    showSeats = showSeats.filter(v => {
        return people>=v.capacity_min && people<=v.capacity_max && v.remain>0
    })
    if(showSeats.length>0 && showSeats[0].grade_seats_selectable){
        form.seat_category_name = showSeats[0].name
        form.seat_category_id = showSeats[0].category_id
    }
}
 
//选择座位  selectable,category_name,id  都传过来了
changeSeat(e){
    let category_id = e.currentTarget.dataset.id
    let category_name = e.currentTarget.dataset.category_name
    let selectable = e.currentTarget.dataset.selectable
    if(!selectable){
        wx.showToast({
            title: '获取超级会员',
            icon: 'none',
            duration: 2000
        })
        setTimeout(()=>{
        	wx.navigateTo({
          	url: '/pages/memberCards/memberCards',
        	})
      	},3000)
     	return
    }
    let form = this.data.form;
    form.seat_category_id = category_id;
    form.seat_category_name = category_name;
    this.setData({
      form
    }) 
}

//输入备注信息
handleTextarea: function (e) {
    console.log(e.detail.value)
    let form = this.data.form
    form.remark = e.detail.value  //绑定输入的值
    this.setData({    
      form: form   
    })
  }
//选择备注并填入input
handleRemark: function (e) {
    let form = this.data.form
    if (form.remark) {
      form.remark = form.remark + '，' + e.currentTarget.dataset.item
    } else {
      form.remark = e.currentTarget.dataset.item
    }
    this.setData({
      form: form
    })

//选择就餐日期触发  显示日期选择器
showDatePicker(){
    this.setData({
        isShowDatePicker: true
    })
}
//选择时间段触发
showTimePicker(){
    this.setData({
      isShowTimePicker:true
     })
}
```



### 门店信息接口 shop/detail  (通过传经纬度拿)

![image-20210419180916260](C:\Users\HP ProDesk\AppData\Roaming\Typora\typora-user-images\image-20210419180916260.png)

```js
 wx.getLocation({
      type: 'wgs84',
      success: function (reser) {
        console.log(reser)
        //授权地图
        app._get('shop/detail', {
          shop_id: options.shop_id || 10001,
          longitude: reser.longitude, //传经纬度给后台
          latitude: reser.latitude   //传经纬度给后台
        }, function (res) {
          let markers = [{
            iconPath: '/images/common/icon-address.png',
            id: 0,
            latitude: 23.099994,
            longitude: 113.324520,
            width: 32,
            height: 32
          }]
          markers[0].latitude = res.data.detail.latitude
          markers[0].longitude = res.data.detail.longitude
          markers[0].title = res.data.detail.shop_name
          self.setData({
            detail: res.data.detail,
            shop_id: options.shop_id || 10001,
            markers: markers,
            isAutoplay:true
          })
        })
      },
     fail: function (err) {
        //未授权时无经纬度
        app._get('shop/detail', {
          shop_id: options.shop_id || 10001,
        }, function (res) {
          let markers = [{
            iconPath: '/images/common/icon-address.png',
            id: 0,
            latitude: 23.099994,
            longitude: 113.324520,
            width: 32,
            height: 32
          }]
          markers[0].latitude = res.data.detail.latitude
          markers[0].longitude = res.data.detail.longitude
          markers[0].title = res.data.detail.shop_name
          self.setData({
            detail: res.data.detail,
            shop_id: options.shop_id || 10001,
            markers: markers,
            isAutoplay:true
          })
        })
      }
```

### 用户信息user/detail

![image-20210419180835868](C:\Users\HP ProDesk\AppData\Roaming\Typora\typora-user-images\image-20210419180835868.png)

```js
//onload声明周期内判断

let self = this
if(wx.getStorageSync('token')){  //判断是否有token 即是否登录
    app._get('user/detail',function(res){ //调用用户信息接口
        if(res.data.userInfo.mobile){
            self.setData({
                mobile: res.data.userInfo.mobile  //拿手机号
            })
        }
    })
}else{
    wx.navigateTo({  //跳转到登录页
        url: '/pages/login/login'
    })
 self.setData(res.data, () => {  //setData还可以传一个回调函数，在页面渲染完成后执行
     self.getReserverSetting(options.shop_id)
 })
}
```



### 获得剩余座位catering.reserve/getOngoingOrderCounts

```js
getReserverInfo(){
    let self = this
    let form = this.data.form
    let data = {
        shop_id: self.data.shop_id
    }
    if(form.reserve_date){
        data.reserve_date = form.reserve_date
    }
    app._get('catering.reserve/getOngoingOrderCounts',data,function(resState){
        let seatInfo = resState.data  //
        self.setData({
            seatInfo
        },()=>{
            self.getRemainSeats()
        })
    })
}
```

### 获得所选日期内的可选时间和座位信息(难点)

![image-20210419181021036](C:\Users\HP ProDesk\AppData\Roaming\Typora\typora-user-images\image-20210419181021036.png)

```js
getRemainSeats() {
    let self = this;
    let form = self.data.form;
    let seatInfo = self.data.seatInfo;
    let seatCategoryList = self.data.seatCategoryList;
    if (form.reserve_date && form.people){
      //获取可选时间
      let timeLines = []
      self.data.timeArr.map(v => {
        let timeDisabled = false //当前时间是否预约已满
        Object.keys(seatInfo).map(item => {
          if (item == (form.reserve_date + ' ' + v)) {
            let remainSeatCount = 0 //剩余可选座位数
            Object.keys(seatInfo[item]).map(seat_category_id => {
              seatCategoryList.map(v2 => {
              if(form.people >= v2.capacity_min && form.people <= v2.capacity_max  && seat_category_id == v2.category_id){
               console.log(item,form.people,v2,seatInfo[item][seat_category_id],seat_category_id)
               if(seatInfo[item][seat_category_id].remain == 0){
                }else{
                  remainSeatCount++
                }
                // timeDisabled = true
              }
            })
            })
            console.log(v,remainSeatCount)
            if(remainSeatCount == 0){
              timeDisabled = true
            }
          }
        })
        if (!timeDisabled) {
          timeLines.push({
            time:v,
            timeState:v,
            disabled:timeDisabled
          })
        }else{
          timeLines.push({
            time:v,
            timeState:v + '(已满)',
            disabled:timeDisabled
          })
        }
      })
      self.setData({
        timeLines
      })
      if (form.reserve_time) {
        //获取可选座位
        seatCategoryList.map(v => {
          Object.keys(seatInfo).map(item => {
            if (item == (form.reserve_date + ' ' + form.reserve_time)) {
              Object.keys(seatInfo[item]).map(seat_category_id => {
                if (v.category_id == seat_category_id) {
                  console.log(seat_category_id)
                  v.remain = seatInfo[item][seat_category_id].remain
                }
              })
            }
          })
        })
        let showSeats = seatCategoryList;
        showSeats = showSeats.filter(v => {
          return form.people >= v.capacity_min && form.people <= v.capacity_max && v.remain >0
        })
        if (showSeats.length > 0 && showSeats[0].grade_seat_selectable) {
          form.seat_category_name = showSeats[0].name;
          form.seat_category_id = showSeats[0].category_id;
        }
        self.setData({
          showSeats,
          form,
          seatCategoryList
        })
      }
    }
  },
      
```



### 门店设置catering.reserve/getSetting

![image-20210419181137017](C:\Users\HP ProDesk\AppData\Roaming\Typora\typora-user-images\image-20210419181137017.png)

```js
getReserverSetting(shop_id) {
    let self = this;
    let form = this.data.form;
    let data = {
      shop_id: shop_id || self.data.shop_id,
    }
    if (form.reserve_date) {
      data.reserve_date = form.reserve_date
    }
    if (form.reserve_time) {
      data.reserve_time = form.reserve_time
    }
    app._get('catering.reserve/getSetting', data, function (resState) {
      console.log(resState)
      let popText = [] //备注提示文字
      let people_num = 0; //可选就餐人数
      if (resState.data.setting) {
        //可选日期范围
        if(self.data.userInfo && self.data.userInfo.grade &&  self.data.userInfo.grade.grade_id){
          var date2 = new Date().getTime() + 24 * 3600 * 1000 * (resState.data.setting.limit_day[self.data.userInfo.grade.grade_id]);
        }else{
          var date2 = new Date().getTime() + 24 * 3600 * 1000 * 15;
        }
        date2 = new Date(date2)
        var seperator1 = "-";
        var year2 = date2.getFullYear();
        var month2 = date2.getMonth() + 1;
        var strDate2 = date2.getDate();
        if (month2 >= 1 && month2 <= 9) {
          month2 = "0" + month2;
        }
        if (strDate2 >= 0 && strDate2 <= 9) {
          strDate2 = "0" + strDate2;
        }
        var currentdate2 = year2 + seperator1 + month2 + seperator1 + strDate2;
        if(resState.data.setting.deny_start_time && resState.data.setting.deny_end_time ){
          self.getDateValid(self.data.currentdate,currentdate2,resState.data.setting.deny_start_time, resState.data.setting.deny_end_time)
        }else{
          self.getDateValid(self.data.currentdate,currentdate2)

        }
        //可选时间
        let timeArr = [];
        let arr = resState.data.setting.active_times.split(';');
        arr.map(v => {
          // let times = v.split('-')
          timeArr.push(v)
        })
        self.setData({
          currentdate2,
          timeArr
        })
        //座位是否需要vip
        if (resState.data.setting.seat_category) {
          resState.data.seatCategoryList.map(v => {
            console.log(resState.data.setting.seat_category[self.data.userInfo.grade.grade_id], v.category_id)
            if (resState.data.setting.seat_category[self.data.userInfo.grade.grade_id].indexOf(v.category_id + '') > -1) {
              v.grade_seat_selectable = true
            } else {
              v.grade_seat_selectable = false
            }
            if (v.capacity_max > people_num ) {
              people_num = v.capacity_max
            }
          })
        }
        self.setData(
          resState.data
        )
        popText = resState.data.setting.remark.split('|');
      } else {
        popText = []
      }
      self.setData({
        popText,
        people_num
      })
      return
    })
  },
```

### user/detail 用户详情



### user/login 用户登录

```js
getUserProfile(){
    wx.getUserProfile(){  //1.拿到getUserprofile返回的userinfo
        desc: '获取你的公开信息',
        success: e => {
            wx.showLoading({
                title: '正在登陆',
                mask: true
            })
            wx.login({    //2. wx登陆Login获取code
                success(res){
                    App._post_form('user/login',{   //3.自己服务器登陆获得token
                        code: res.code,
                        user_info: JSON.stringify(e.userInfo),
                        refer_id: wx.getStorageSync('refer_id')
                    },result => {
                        wx.setStorageSync('token',result.data.token)
                        wx.setStorageSync('user_id',result.data.user_id)
                    },false,() => {
                        wx.hideLoading()
                    })
                }
            })
        }
    }
}
```

### 获取手机号 （和用户信息不同接口）

```js
getPhone: function (e) {
    console.log(e)
    const _this = this;
    if (e.detail.iv) {
      App._post_form('user/phone', {
        "iv": e.detail.iv,
        "encryptedData": e.detail.encryptedData,
      }, function (res) {
        wx.setStorageSync('mobile', res.data.phone)
        _this.onNavigateBack(1);

      });
    } else {
      return;
    }
  },
```



### 跳转回授权页 doLogin

```js
 doLogin(delta) {
    // 保存当前页面
    let pages = getCurrentPages();
    if (pages.length) {
      let currentPage = pages[pages.length - 1];
      "pages/login/login" != currentPage.route &&
        wx.setStorageSync("currentPage", currentPage);
    }
    // 跳转授权页，传delta给login页保存
    wx.navigateTo({
      url: "/pages/login/login?delta=" + (delta || 1)
    });
  },
```



### css方法底部安全距离

```js
//100vh-(banner+tabbar) - 底部安全距离  (css提供的env方法)
style="height:calc(100vh - {{banners.length > 0 ? '352' : '100'}}rpx - env(safe-area-inset-bottom)"
```



### 点餐首页相关逻辑

```js
//获取左侧分类
 getCateList () {
    let _this = this;
    App._get('catering.category/index', {
      seat_id: wx.getStorageSync('seat_id'),
      shop_id: wx.getStorageSync('shop_id') || App.getShopId()
    }, function (res) {
      let list = res.data.list;
      let cateList = []
      list.map(v => {
        if (v.child) {
          v.child.map(item => {
            cateList.push(item)
          })
        } else {
          cateList.push(v)
        }
      })
      _this.setData({
        cateList: cateList,
        selectedNavId: cateList[0].category_id
      }, () => {
        //初始化获取分类第一项商品
        _this.getCateProduct(cateList[0].category_id);
      })

    });
     
 //根据id获取2级分类
 getCateProduct(id, type) {  
    let _this = this;
    if (type == 1) { 		//传了type==1  
      this.data.page += 1   //请求时当前page+1
    } else { 				//type没传，page=1
      this.data.page = 1
    }
    wx.showLoading({
      title: '加载中',
      mask: true
    })
    App._get('catering.goods/lists', {
      seat_id: wx.getStorageSync('seat_id'),
      shop_id: wx.getStorageSync('shop_id') || App.getShopId(),
      category_id: id,
      listRows:50,
      page: _this.data.page
    }, function (res) {
      wx.hideLoading()
      let arr = [];
      if (type == 1) { //其实type是一个状态值，传入时判断加载下一页
        arr = _this.data.productList;
        for (let i in res.data.list.data) {
          arr.push(res.data.list.data[i]) 
        }
      } else {
        arr = res.data.list.data
      }
      arr.map(v =>{
        v.sellingPoint = v.selling_point.split(' ')
      })
      _this.setData({
        productList: arr
      })
    });
     
 //点击左侧一级列表
 checkNav(e) {  //通过data-id把cateId传过来
    let $index = e.currentTarget.dataset.index;
    let id = e.currentTarget.dataset.id;
    this.getCateProduct(id); //调用获取二级分类方法
    this.setData({
      item_id:'item' + $index,
      isShowSelect:false,
      selectedNav: $index,
      selectedNavId: id
    })
  },
```



### 点击容器外区域隐藏容器的实现原理

1.创建一个满屏父容器，设置rgba为阴影色 实现图层效果

2.父容器内创建一个要显示的子容器，fixed在要固定的位置

3.如果有滚动条的界面 要对父容器添加**catchtouchmove="preventTouchMove"  防止滚动穿透**

4.父容器绑定 catchtap防止子容器一起消失

注意：若居中显示子容器，可再添加一个满屏的透明**兄弟容器**，此时点击该子容器并绑定catchtap不会冒泡给兄弟容器和父容器

### 

### web Socket协议

socket属性:

**socket.readyState** 

- 0 - 表示连接尚未建立。
- 1 - 表示连接已建立，可以进行通信。
- 2 - 表示连接正在进行关闭。
- 3 - 表示连接已经关闭或者连接不能打开

**socket.bufferedAmount**

只读属性 bufferedAmount 已被 send() 放入正在队列中等待传输，但是还没有发出的 UTF-8 文本字节数。

**事件：**

socket.onopen		 连接建立时触发

socket.onmessage   接受数据时触发

socket.onerror         通信错误时触发

socket.onclose         关闭时触发

方法：

socket.send()   使用连接发送数据

socket.close()   关闭连接

```js
var ws = new WebSocket("ws://localhost:9998/echo")
ws.onopen = function(){
     // Web Socket 已连接上，使用 send() 方法发送数据
    ws.send("发送数据");
   	alert("数据发送中...");
}
wx.onmessage = function(evt){
    var received_msg = evt.data;
    alert("数据已接收...");
              
}
```



### wx.connectSocket

```js
//创建socket链接
wx.connectSocket({
  url: 'wss://example.qq.com',
  header:{
    'content-type': 'application/json'
  },
  protocols: ['protocol1']
})
```

### wx.onSocketOpen(function callback)

监听 WebSocket 连接打开事件

Object res   返回header  连接成功的 HTTP 响应 Header

### wx.onSocketMessage(function callback)

function callback 接受到服务器的消息事件的回调函数

返回data ：服务器返回的消息



### wx.sendSocketMessage(Object object)

通过 WebSocket 连接发送数据。需要先 **wx.connectSocket**，并在 wx.onSocketOpen 回调之后才能发送。



### SocketTask

webSocket任务  可通过wx.connectSocket()接口创建返回

SocketTask.send(obj  obj)  发送数据

SocketTask.close(obj obj) 关闭链接



### jm点击报名逻辑

```js
//无手机号情况点击报名，先获取用户手机号
getPhone: function (e) {
    const _this = this;
    if(app.isFastClick()){
      return
    }
    if (e.detail.encryptedData) { //该数据存在表示用户授权手机号
      app._get('?s=/api/user/phone', {
        iv: e.detail.iv,
        encryptedData: e.detail.encryptedData,
        token: wx.getStorageSync('token'),
        shop_id: app.shop_id
      }, function (res) {
        console.log(res, '授权手机号')
        app.log.info(res, '授权手机号');
         // wx.showLoading({
        //   title: '会员卡生成中...',mask:true
        // })
        // _this.loopFun();
        _this.getUserInfo();  //拿到手机号，执行getUserInfo拿用户信息
      });
    } else {
      return;
    }
  },   
 //再调用接口获取用户信息     
getUserInfo() {  
    let _this = this;
    app._get('?s=/api/user/detail', {
      shop_id: app.shop_id
    }, function (res) {
      wx.setStorageSync('userInfo', res.data.userInfo);
      _this.setData({
        isLogin: !!res.data.userInfo.avatarUrl|| false, //拿不到头像表示没有登陆
        userInfo: res.data.userInfo
      })
    }, (res) => {
      console.log('fail', res)
    }, (res) => {
      wx.hideLoading();
    });
  },
      
 
  //有手机号点击报名，调用signUp 并弹出注册框
  signUp() {
    if (!this.data.userInfo.mobile) {
      this.setData({
        canShow: false,
      })
      return
    } {
      this.setData({
        canShow: true
      })
    }
    this.getUserLastExtract()
    this.setData({
      showSign: true   //调起报名框的状态值
    });
  },
      
  
  //报名框双向绑定  bindinpunt="changeInput"
 changeInput(e) {
    let obj = this.data.popupInfo;
    obj[e.currentTarget.dataset.item] = e.detail.value; //把输入框的值绑定给data对象
    this.setData({
      popupInfo: obj  //更新data对象的值，实现双向绑定
    })
  },
```



### mill阅卷端

```js
//下一位
next: function() {
    let $num = this.data.questionNum;
    let childrenList = this.data.childrenList; 
    if ($num >= childrenList.length) {
      return;
    }
    $num++;
      this.updownFun('down', $num);
  },

//切换学生 下一位
updownFun: function(param, num) { 
    let self = this;
    let exam_id = this.data.exam_id;
    let question_id = this.data.question.question_id;
    let student_id = this.data.student.student_id;
    let dd = {
      exam_id: exam_id,
      question_id: question_id,
      student_id: student_id,
      op: param,
    }
    app._get('exam.teacher.question/updown', dd, function(res) {
      let question = self.formatQuestion(res.data.student_question) //获取的数据格式化
      self.setData({
        // correct: res.data.correct,
        question: res.data.student_question,
        student: res.data.student,
        questionNum: num,
        exam_student_id: res.data.exam_student_id,
      })
    })
  },
  //格式化接口返回的题目数据
 formatQuestion(question){
    let self = this;
    
    let type = question.question.type.value;
    if (question.question.options) {
      question.question.options = self.optionsFun(question.question.options, question);
      }
    if (type == 2 && question.answer || type == 3 && question.answer) {
      let answer = question.answer.split(",");
      question.question.options.forEach(function (items, j) {
          if (answer.indexOf(items.value) < 0) {
            items.showHidden = false;
          } else {
            items.showHidden = true;
          }
        })
      }
    question.answer = question.answer && question.answer.toUpperCase();
    question.question.answer = question.question.answer.toUpperCase();
    if (question.question.answer.indexOf(',') == 0){
      question.question.answer = question.question.answer.substr(1)
    }
    return question
  },
 
      
//input保存绑定提交的分数
  scoreUpdate: function(e) {
    let value = e.detail.value;
    let scoreMax = this.data.question.question.score; //满分有几分
    if (value > scoreMax) {
      value = scoreMax;
    }
    let num = this.data.questionNum - 1;
    this.setData({
      ['question.score']: value,  //当前题得分
      ['childrenList[' + num + '].score']: value, //保存对应学生的分数到批改学生数组中
      ['childrenList[' + num + '].is_correct']: 1, //已批改状态
    })
  },
      
//提交批改
  upDate: function() {
    let childrenList = this.data.childrenList;
    let question = this.data.question;
    let scoreNum = 0;
    let self = this;
    childrenList.forEach(function(item, i) {
      if (item.is_correct == 0) { //如果是未批该，scoreNum变量+=1
        scoreNum += 1;
      }
    })
    console.log(scoreNum, childrenList)
    if (scoreNum == 0) {  //所有题目都已批改
      this.correctFun(this.backFun) //关键句：调用提交方法, 并backFun跳转列表页
    } else { //还有未批改的学生，开启提示
      wx.showModal({
        title: '温馨提示',
        confirmText: '提交',
        content: '您还有' + scoreNum + '道题目未批改是否提交成绩 ',
        confirmColor: '#A57324',
        success: function(res) {
          if (res.confirm) {
            if (question.score) {
              self.correctFun(self.backFun)
            } else {
              self.backFun();
            }
          }
        }
      })
    }

  },
      
 //每题提交分数(点上一题，下一题，提交批改都会触发提交)
 correctFun: function(fn, num) {
    let self = this;
    let exam_id = this.data.exam_id;
    let question_id = this.data.question.question_id;
    let student_id = this.data.student.student_id;
    let score = this.data.question.score;
    let exam_student_id = this.data.question.exam_student_id;
    let dd = {
      exam_id: exam_id,
      question_id: question_id,
      student_id: student_id,
      score: score,
      exam_student_id: exam_student_id,
      wxapp_id: 10002
    }
    app._post_form('exam.teacher.question/correct', dd, function(res) {
      if (num) {  //传了num,执行updawn()函数
        fn('down', num)
      } else {  //没传，直接执行传入的函数
        fn()
      }
    })
  },
 //跳转回列表页
backFun: function() {
    wx.showModal({
      title: '提交成功',
      content: '',
      showCancel: false,
      confirmColor: '#A57324',
      success: function() {
        wx.navigateBack({
          delta: 1
        })
      }
    })
  },
```

 

### 27获取二级菜单逻辑

```js
//获取2级菜品
getCateProduct: function (id, type) { 
    let _this = this;
    if (type == 1) {
      this.data.page += 1
    } else {
      this.data.page = 1
    }
    wx.showLoading({
      title: '加载中',
      mask: true
    })
    //这个接口会直接返回所有菜品，需要根据每个菜所属的cate,创建对应的数组数据
    App._get('catering.goods/lists', {
      seat_id: wx.getStorageSync('seat_id'),
      shop_id: wx.getStorageSync('shop_id') || App.getShopId(),
      // category_id: id,  //这个接口不需要传cate_id了
      listRows:1000,
      search:_this.data.keywords,
      page: _this.data.page
    }, function (res) {
      wx.hideLoading()
      let arr = [];
      if (type == 1) {
        arr = _this.data.productList;
        for (let i in res.data.list.data) {
          arr.push(res.data.list.data[i])
        }
      } else {
        arr = res.data.list.data
      }
      let sortedArr = []
      _this.data.cateList.map(cate =>{  //遍历一级分类的cate_id
        arr.map(v =>{  		//在内部遍历之前拿到的二级所有菜品
          v.sellingPoint = v.selling_point.split(' ')
          if(v.category_id == cate.category_id){ //对比二级和一级的cate_id,若相等则存入新数组
            sortedArr.push(v)   
          }
          })
      })
      _this.setData({
        productList: sortedArr,  //保存二级菜单数据
        
      },()=>{
        isGoNext = false
        _this.getCateTopInfo()
      })
    });
  },
      
 //更新商品规格信息
  _updateSpecGoods() {
    let _this = this,
      specSkuId = goodsSpecArr.join('_');
    // 查找skuItem
    let spec_list = _this.data.data1.goodsMultiSpec.spec_list,
      skuItem = spec_list.find((val) => {
        return val.spec_sku_id == specSkuId;
      });
    // 记录goods_sku_id
    // 更新商品价格、划线价、库存
    if (typeof skuItem === 'object') {
      let data1 = _this.data.data1;
      data1.goods_sku_id = skuItem.spec_sku_id,
        data1.goods_price = skuItem.form.goods_price,
        data1.line_price = skuItem.form.line_price,
        data1.stock_num = skuItem.form.stock_num,
        //当前规格的展示图
        //data1.skuCoverImage = skuItem.form.image_id > 0 ? skuItem.form.image_path : _this.data.detail.goods_image
        _this.setData({
          data1: data1
        });
    }
  },
 
 //初始化商品详情
_initGoodsDetailData(data) {
    let _this = this;
    // 商品详情
    let goodsDetail = data.detail;
    // 富文本转码
    // if (goodsDetail.content.length > 0) {
    //   wxParse.wxParse('content', 'html', goodsDetail.content, _this, 0);
    // }
    // 商品价格/划线价/库存
    data.goods_sku_id = goodsDetail.goods_sku.spec_sku_id;
    data.goods_price = goodsDetail.goods_sku.goods_price;
    data.line_price = goodsDetail.goods_sku.line_price;
    data.sellingPoint = goodsDetail.selling_point.split(' ');
    data.stock_num = goodsDetail.goods_sku.stock_num;
    // 商品封面图(确认弹窗)
    data.skuCoverImage = goodsDetail.goods_image;
    // 多规格商品封面图(确认弹窗)
    if (goodsDetail.spec_type == 20 && goodsDetail.goods_sku['image']) {
      data.skuCoverImage = goodsDetail.goods_sku['image']['file_path'];
    }
    // 初始化商品多规格
    if (goodsDetail.spec_type == 20) {
      data.goodsMultiSpec = _this._initManySpecData(goodsDetail.goods_multi_spec);
    }
    // 初始化套餐商品多规格
    if (goodsDetail.is_combo_goods == 1) {
      data.goodsCombo = _this._initManyComboSpecData(goodsDetail);
    }
    return data;
  },
```



### mill支付方式相关payTypes

```js
//选择支付图标时触发
selectPayType: function(e) {
			let $id = e.currentTarget.dataset.id;
			let $name = e.currentTarget.dataset.name;
			if($id == 105  && this.detail.is_member == 0 && !this.detail.realName){
				uni.showToast({
					title:'无会员名字备注和会员身份无法挂帐',
					icon:'none'
				})
				return
			}
			if($id == 10 && this.card_info && this.card_info.length == 0){
					uni.showToast({
						title: '该用户暂无储值卡，无法使用储值支付',
						icon: 'none'
					});
					return;
			}else{
				this.user_card_id = '';
				this.user_card_id_index = 0
			}
			if($id == 1000){
				if (this.putText != '上菜完毕，待买单') {
					uni.showToast({
						icon: 'none',
						title: '部分菜品未上菜,无法结账'
					});
					return;
				}
				this.showMixPayWayPopup()
				this.setData({
					choosePayName: $name,
					choosePayType: $id
				});
				return
			}
			this.setData({
				choosePayName: $name,
				choosePayType: $id
			});
			this.$nextTick(function() {
				if(this.choosePayType == 10){
					if(this.card_info.length == 1){
						this.user_card_id = this.card_info[0].user_card_id
							this.$nextTick(function() {
								this.getCoupons(this.id);
							})
					}else{
						uni.showToast({
							title: '请先选择用户的储值卡',
							icon: 'none'
						});
						return;
					}
				}else{
					this.getCoupons(this.id);//美团，抖音等其他情况，调用这个方法
				}
				
			});
		},
 //获取优惠信息并刷新页面 
 //关键点：根据payType中每个支付方式不同的value传给接口，接口返回相应的优惠,前端无需特殊处理
getCoupons: function(id) {
			let _this = this;
			getApp().globalData._get(
				'catering.order.order/checkOut',
				{
					is_user_grade:_this.is_user_grade,
					order_id: id,
					discountRatio:
						_this.manual_order_discount_ratio_index > 0
							? _this.discountRatioArr[_this.manual_order_discount_ratio_index].discount_ratio
							: _this.discountRatio.toFixed(2),
					service_fee_ratio:_this.serviceFeeArr[_this.service_fee_arr_index].ratio || 0,
					coupon_id: _this.selectCouponId,
					payType: _this.choosePayType,
					erase_zero:_this.erase_zero + 0,
					pay_mix: _this.choosePayType == 1000 ? JSON.stringify(this.pay_mix) : '',
					//酒水折扣
					// manual_order_discount_ratio: _this.manual_order_discount_ratio_index > 0 ?  _this.discountRatioArr[_this.manual_order_discount_ratio_index].discount_ratio : 1,
					catering_discount_id: _this.manual_order_discount_ratio_index > 0 ? _this.discountRatioArr[_this.manual_order_discount_ratio_index].id : '',
					//其他折扣
					extra_order_discount: _this.extra_order_discount_index > 0 ? _this.discountExtraArr[_this.extra_order_discount_index].cut_value : 0,
					extra_order_discount_text: _this.extra_order_discount_index > 0 ? _this.discountExtraArr[_this.extra_order_discount_index].name : 0,
					extra_order_discount_price: _this.extra_order_discount_index > 0 ? _this.discountExtraArr[_this.extra_order_discount_index].price : 0,
					 extra_order_discount_id: _this.extra_order_discount_index > 0 ? _this.discountExtraArr[_this.extra_order_discount_index].id : '',
					user_card_id:_this.user_card_id || '',
				},
				function(res) {
					let no_coupon = {
						user_coupon_id: '',
						name: '不使用优惠券'
					};
					res.data.coupon_list.unshift(no_coupon);
					_this.order = res.data;

					_this.getOrderDetail(_this.id);
				}
			);
		},
```



### mill编辑会员信息逻辑

```js
//1.改会员信息请求  catering.order.order/changeUser

//2.catering.order.order/checkOut

//3.重新渲染页面详情 catering.order.order/detail 
```



### mill 登陆态设置过期时间--后端设置

```js
//登陆请求
login: function () {
      // 登录
      let _this = this;
      if (!_this.userValue) {
        uni.showToast({
          title: '请输入账号',
          icon: 'none'
        });
        return;
      }
      if (!_this.psdValue) {
        uni.showToast({
          title: '请输入密码',
          icon: 'none'
        });
        return;
      }
      getApp().globalData._post_form('passport/login', {
        'User[user_name]': _this.userValue,
        'User[password]': _this.psdValue,
        'User[wxapp_id]': getApp().globalData.getWxappId(),
        uniacid: getApp().globalData.uniacid,
        wxapp_id: getApp().globalData.getWxappId()
      }, res => { //登陆关键缓存:authKey sessionId
        console.log(res);
        uni.setStorageSync("sessionId", res.data.sessionId);
        uni.setStorageSync("authKey", res.data.authKey);
        uni.setStorageSync("shop_id", res.data.user.shopList[0].shop_id);
		uni.setStorageSync("shop_name", res.data.user.shopList[0].short_name);
		uni.setStorageSync("shopList", res.data.user.shopList);
        uni.setStorageSync("userInfo", res.data.user);
        uni.redirectTo({
          url: '/pages/index/index'
        });
      }, null, () => {
        uni.hideLoading();
      });
    },
```



### JM商城相关逻辑

```js
//相关请求
//1. category/index  主分类接口 运动器材，健康食品等
//2. goods/lists     详细商品接口  
```

```html
<!--嵌套遍历中，直接在wx:if中判断子商品和父类的catid是否一致从而显示对应类别商品-->
<!--关键句:  wx:if={{ite.category_id == item.category_id}}   -->
 <view wx:for="{{lists}}" wx:key="index" wx:for-item="ite">
      <view class="title">{{ite.name}} <text bindtap="showAll" data-category_id="{{ite.category_id}}" data-category_name="{{ite.name}}">更多></text></view>
      <view class="cards-wrap">
<view class="card" wx:for="{{goods}}" wx:for-index="idx" wx:if="{{ite.category_id == item.category_id}}" data-goods_id="{{item.goods_id}}" bindtap="goodsDetail">
          <image src="{{item.goods_image}}" mode="aspectFill">
            <text wx:if="{{item.selling_point}}">{{item.selling_point}}</text> </image>
          <view class="card-des">{{item.goods_name}}
          </view>
          <view class="stock-none" wx:if="{{item.stock == 0}}">已售罄</view>
          <view class="time" wx:if="{{showTime && goods_time[idx].strTime != 0}}">距开售：{{goods_time[idx].strTime}}</view>
          <view class="card-score">
             ￥{{item.goods_sku.goods_price}} <text style="color:#bbb;font-size:24rpx;margin-left:20rpx;">已售：{{item.goods_sales}} </text></view>
        </view>
     </view>
```



### mill根据url传参后，接口动态修改参数思路

```js
//单独抽一个方法设置wxapp_id,不能写在读取参数的地方。否则参数都会有问题
setWxappId(){
	let routes = getCurrentPages() //页面栈数组
	let curOptions = routes[routes.length - 1].options
	let {wxapp_id} = curOptions	
	uni.setStorageSync("wxapp_id",wxapp_id)
								
},
//获取wxappid的方法,仅供接口使用
getWxappId() {
	return uni.getStorageSync("wxapp_id") || siteinfo.wxapp_id
},
    
//auth.vue登录页
 onShow:function(){
     _this.setWxappId()  //第一次登陆就设置wxappId，后续接口的参数都不会有问题了
 }
```



### 丁大牙用户端支付逻辑

```js
payOrder(){
    let _this = this;
    // wx.showLoading({
    //   title: '加载中',
    //   mask:true
    // })
    
    let payType=20;
    if (_this.data.curPayType==20){
      //微信支付
      payType = 20;
    } else if (_this.data.curPayType == 10){
      //储值卡支付
      payType = 10;
      if (!_this.data.passwordValue){
        // wx.hideLoading();
        _this.setData({
          showInpPsd:true,
          passwordValue:'',
          inpFocus:true
        })
        return;
      }
    } 
    // else if (_this.data.selectPayType == 2) {
    //   //现金支付
    //   payType = 20;
    // }
    App._post_form('catering.order/checkOut', {
      order_id: _this.data.orderId,
      check_price:_this.data.orderDetail.order_pay_price,
      coupon_id:_this.data.selectCouponId ||0,
      pay_type:payType,
      is_use_points: _this.data.isUsePoints ? 1 : 0,
      seat_id: wx.getStorageSync('seat_id'),
      password:_this.data.passwordValue
    // App._post_form('catering.order/cart', {
    //   pay_type:payType,
    //   coupon_id: _this.data.selectCouponId
    }, (result) => {
      // wx.hideLoading();
      console.log(result)
      //价格变化重新请求订单
      if(result.data == 'reload'){
        wx.showToast({
          title: '订单价格发生变化，请重新确认支付',
          duration:2500,
          icon: 'none'
        })
        _this.getOrderDetail()
        return
      }

      if (!result.data.payment.nonceStr){
        wx.showToast({
          title: '支付成功',
          icon: 'none'
        })
        setTimeout(function () {
          wx.redirectTo({
            url: '/Catering/pages/order/order',
          })
        }, 800)
      }else{
        wx.requestPayment({
          timeStamp: result.data.payment.timeStamp,
          nonceStr: result.data.payment.nonceStr,
          package: 'prepay_id=' + result.data.payment.prepay_id,
          signType: 'MD5',
          paySign: result.data.payment.paySign,
          success(res) {
            App.socketSendServerGroup();
            console.log(res, '支付成功');
            wx.showToast({
              title: '支付成功',
              icon: 'none'
            })
            App._post_form('order/payNotice', {
              order_id: _this.data.orderId,
              result: 'success',
            }, (res) => {
              setTimeout(function () {
                wx.redirectTo({
                  url: '/Catering/pages/order/order',
                })
              }, 800)
            })
            
          },
          fail(err) {
            console.log(err, '支付失败');
            App._post_form('order/payNotice', {
              order_id: _this.data.orderId,
              result: 'fail',
            }, (res2) => {
              wx.showModal({
                title: '提示',
                content: '支付失败',
                confirmText: '返回首页',
                success: function (res) {
                  if (res.confirm) {
                    console.log('用户点击确定')
                    wx.redirectTo({
                      url: '/Catering/pages/order/order',
                    })
                  } else if (res.cancel) {
                    console.log('用户点击取消')
                  }
                }
              })
            })
           
          }
        });
      }
     
    },(err)=>{
      wx.hideLoading();
      _this.setData({
        passwordValue:''
      })
    },()=>{
     setTimeout(()=>{
      wx.hideLoading();
     },1500)
      
    });
    
  },
```



### 字符串转数字，数字转字符串快捷方法

```js
//字符串转数字, 字符串-0
let str = '123'
console.log(str - 0) // 123

//数字转字符串，后面+ ''
let str2 = 123
console.log(str2 + '') //'123' 
```



### 伪元素::after给文字添加背景色

```css
/*在文字cate-name类之后添加一个椭圆形的背景色*/
.cate-name::after{
  position: absolute;
  top: 0rpx;
  left: 0rpx;
  right: 0rpx;
  content: '';
  z-index: -1;
  bottom: 0rpx;
  border-radius: 50%;
  background: rgba(248, 182, 44, 1);
}
```



### Object.assign 合并对象

将源对象（source）的所有可枚举属性，复制到目标对象（target）。

```js
const target = { a: 1 };

const source1 = { b: 2 };
const source2 = { c: 3 };

Object.assign(target, source1, source2);
target // {a:1, b:2, c:3}

//实际用法
//将多个对象合并到某个对象
const merge = (target, ...sources) => Object.assign(target, ...sources);
//合并多个对象并返回一个新对象
const merge = (...sources) => Object.assign({}, ...sources);

//将属性x,y添加到对象point类对象实例中
class Point {
  constructor(x, y) {
    Object.assign(this, {x, y});
  }
}

//给对象添加方法
Object.assign(SomeClass.prototype, {
  someMethod(arg1, arg2) {
    ···
  },
  anotherMethod() {
    ···
  }
});

// 等同于下面的写法
SomeClass.prototype.someMethod = function (arg1, arg2) {
  ···
};
SomeClass.prototype.anotherMethod = function () {
  ···
};
```



### DDY扫码进入时场景逻辑

**onshow时** 

1.先进行wss连接初始化，

2.执行登陆操作 wx.login -> 自己平台login 判断是否有手机号，没有跳转到login进行授权

**onload时**

3.执行authAddress获取地理位置,并执行**getInfo** (获取shop详情，判断用户是否已wx.login状态,并进行页面跳转)

**点击”开始点餐“**

1.执行getAddress(获取地理位置, 在成功的回调内执行openTable,  失败也执行openTable不传经纬度)

2.openTable, 调接口传人数桌位，经纬度等，执行socketAddGroup 传消息给后台，并根据桌位的status跳转到相应页面

```js
//存疑： 这个方法有问题，options已经是一个对象了，为什么要用decodeURIComponent 对url解码？
onload: function(options){ //options会传入url携带的seat_id, shop_id, wxapp_id参数
    let scene = app.getSceneData(options)
    console.log(scene) //存疑： 此处返回 {} 表示undefined
}

//全局 app.js  获取传入的url参数并使用util对其格式化
getSceneData(query) {
    return query.scene ? util.scene_decode(query.scene) : {};
  },
      
//util.js 
scene_decode(e) {
    if (e === undefined)
      return {};
    let scene = decodeURIComponent(e),
      params = scene.split(','),  //把字符串键值对拆成数组
      data = {};
    for (let i in params) { //再遍历每个键值对数组
      var val = params[i].split(':'); //把'name: xxx'这种，拆成['name','xxx']数组
        //对data进行 data[name] = value 赋值
      val.length > 0 && val[0] && (data[val[0]] = val[1] || null)
    }
    return data;
  },
//--------------------------------------------------------------------------------
 
//app.js 全局初始化wss
 sockectInitConnect() {
    let currentSocket;
    const _this = this;
    currentSocket = wx.connectSocket({
      url: wss_url,
      success: function (res) {
        //{socketTaskId: 5, errMsg: "connectSocket:ok"} "successInit
        console.log(res, 'successInit')
      },
      fail: function (err) {
        console.log(err, 'failInit')
      }
    })
     //接收服务器返回的ws消息
    wx.onSocketMessage(function (res) {     
    //{data: "{"type":"message","client_id":"ac1039ce0b540000f7fc"}"} "socketInfo"
      console.log(res, 'socketInfo')
      let data = JSON.parse(res.data)
      if(data.client_id){
          //第一次连接，服务器会返回client_id,可进行接口请求操作
          //请求成功后，后续的连接不会再返回client_id
        _this._get('user/bindClient', {
          client_id:data.client_id
        }, function (result) {
      //{code: 1, msg: "success", data: Array(0)}'bindClient'
          console.log(result, 'bindClient')
        })
      }
    },)
     //保存currentSocket，就是web Socket的一个实例
    this.globalData.currentSocket = currentSocket
  },
 //根据currentSocket参数对ws重连判断
 sockectReConnect(currentSocket) {
    console.info("进入了重连");
    console.info(currentSocket);
    if (!currentSocket) { //若socket实例不存在，重新初始化ws连接
      this.sockectInitConnect();
      return;
    }
     //readystate状态不是1.未开始 2.已建立 也初始化ws连接
    if (currentSocket.readyState !== 0 && currentSocket.readyState !== 1) {
      this.sockectInitConnect();
    }
  },
      
//发送socket信息给服务器的方法 
socketAddGroup() {
    let _this = this;
    var send = { //要发送的信息对象
      type: 'group',
      group_id: 'ex_' + _this.getWxappId() + '_' + _this.getShopId() + '_seat_' + 						wx.getStorageSync("seat_id"),
      msg: 'add group'
    }
    send = JSON.stringify(send)
    wx.sendSocketMessage({
      data: send,
      complete: function (data) {
        console.log('加入分组', data)
      }
    })
  },
    
 //扫码页初始化时执行的操作
 //onshow时，建立webSocket连接，执行登陆
onShow: function(){
    if(wx.getStorageSync('token')){
        this.connectSocket() //1. 已有token,建立wss连接
    }else{
        this.loginAction()  //2.登陆,并在login最后执行wss连接
    }
    
    this.authAddress()  //获取位置信息，并执行getInfo()
}
 //1.wss连接
 connectSocket(){
    let currentSocket = App.globalData.currentSocket
    console.log('onShow');
    console.log(currentSocket);
     //这个方法会判断currentSocket状态，若currentSocket不对，执行initsocket初始化方法
    App.sockectReConnect(currentSocket);  
  },
      
  //2.授权登陆
loginAction: function (e) {
    console.log(1)
    let _this = this;
    wx.showLoading({
      title: "正在登录",
      mask: true
    });
    // 执行微信登录
    wx.login({
      success: function (res) {
        // 执行自己平台登陆
        App._post_form('user/login', {
          code: res.code,
          user_info: '',
          encrypted_data: '',
          iv: '',
          signature: '',
          referee_id: ''
        }, function (result) {
          // 缓存token，user_id
          wx.setStorageSync('token', result.data.token);
          wx.setStorageSync('user_id', result.data.user_id);
          if (result.data.user_info.nickName!=''){
            wx.setStorageSync('IsLogin', '1');
          }
            //关键点，判断是否有手机号，没有执行dologin授权，即跳转到login/login页面
          if (!result.data.user_info.mobile){ 
            App.doLogin() 
          }else{
            wx.setStorageSync('mobile', result.data.user_info.mobile)
            _this.connectSocket() //执行wss初始化连接
          }
        }, false, function () {
          wx.hideLoading();
        });
      }
    });
  },
      
      
doLogin(delta) {
    // 保存当前页面
    let pages = getCurrentPages();
    if (pages.length) {
      let currentPage = pages[pages.length - 1];
      "pages/login/login" != currentPage.route &&
        wx.setStorageSync("currentPage", currentPage);
    }
    // 跳转授权页面
    wx.navigateTo({
      url: "/pages/login/login?delta=" + (delta || 1)
    });
  },
 

 authAddress(){
     wx.getLocation({
         //code
         success(res){
             //把返回的经纬度，传给getInfo方法
             _this.getInfo(wx.getStorageSync('seat_id'), latitude, longitude)
         },
         fail(res){
             _this.addressModal() //获取位置失败，执行提示再次授权
         }
     })
 }

//开始点餐事件
 getAddress:function(){
    let _this = this;
    if(this.data.number == 0){
      wx.showToast({
        icon:'none',
        title:'请先选择就餐人数'
      })
      return
    }
    wx.getLocation({
      type: 'wgs84',
      success(res) {
        _this.setData({
          IsLocation:true
        })
        console.log(res)
        const latitude = res.latitude
        const longitude = res.longitude
        _this.openTable(latitude, longitude);
      },
      fail(res){
        console.log('fail',res)
        _this.openTable('','');
      }
    })
  },
 
//openTable
openTable: function (latitude,longitude){
    let _this=this;
    if (!wx.getStorageSync('seat_id')){
      wx.setStorageSync('seat_id', 1)
    }
    App._get('catering.seat/scan', {
      people: _this.data.number,
      seat_id: wx.getStorageSync('seat_id'),
      latitude,
      longitude
    }, function (res) {
      console.log(res,'location')
      App.socketAddGroup();
      if (res.data.seat_status.value == 1 || res.data.seat_status.value == 0){
        //开台未点餐
        wx.redirectTo({
          url: '/Catering/pages/index/index',
        })
      } else if (res.data.seat_status.value == 2){
        //2已下单，3已支付
        wx.redirectTo({
          url: '/Catering/pages/order/readyOrder/readyOrder?orderId=' + res.data.order_info.order_id,
        })
      } else if (res.data.seat_status.value == 3) {
        //2已下单，3已支付overOrder
        wx.redirectTo({
          url: '/Catering/pages/order/overOrder/overOrder?orderId=' + res.data.order_info.order_id,
        })
      }else{
        wx.showToast({
          title: '系统异常,请重新扫码',
          icon:'none'
        })
      }
      App.log.info(_this.data.number,latitude,longitude, '点餐扫码参数');
    });
  }
```



### 善语退款审核(虚拟商品)

```js
//拒绝退款，输入拒绝原因 
//参数is_agree: 20(拒绝)，address_id: refuse_desc: order_refund_id: 15   refund_money: 0
shop/order.refund/audit?is_agree=20&address_id=&refuse_desc='拒绝原因'&order_refund_id=15&refund_money=0

//同意退款
//参数：is_agree: 10(同意) address_id: refuse_desc: order_refund_id: 16  refund_money: 0
shop/order.refund/audit?is_agree=10&address_id=&refuse_desc=&order_refund_id=16&refund_money=0

```



### 时享生活(JM)

获取优惠券，并进行抵扣

```js
//报名活动接口：activity.order/join
//传参activity_id  extra_info   user_coupon_id(优惠券)

//获取优惠券接口： activity.index/userCouponLists  
//传参: activiy_id 
```



### referee_id(推荐人，进入场景)相关逻辑

```js
//  e: {path,qeury:{}, referrerInfo, scene ,shareTicket }
onLaunch(e){
    let _this = this;
    // 小程序主动更新
    _this.updateManager();
    // 小程序启动场景
    _this.onStartupScene(e.query);
    _this.setNavBar();
}

//小程序启动场景
onStartupScene(query) {
    // 获取场景值
    let scene = this.getSceneData(query);
    // 记录推荐人id
    let refereeId = query.referee_id ? query.referee_id : scene.uid;
    refereeId > 0 && (this.saveRefereeId(refereeId));
  },
    
   /**
   * 记录推荐人id
   */
  saveRefereeId(refereeId) {
    if (!wx.getStorageSync('referee_id'))
      wx.setStorageSync('referee_id', refereeId);
  }

   //获取场景值
  getSceneData(query) {
    return query.scene ? util.scene_decode(query.scene) : {};
  },  
```



### mill今日订单昨日订单逻辑

当前时间<早上6点 取昨日时间

```js
//年月日转化
timestampToYear: function(timestamp) {
	var date = new Date(timestamp * 1000); //时间戳为10位需*1000，时间戳为13位的话不需乘1000
	var Y = date.getFullYear() + '-';
	var M = (date.getMonth() + 1 < 10 ? '0' + (date.getMonth() + 1) : date.getMonth() + 1) + '-';
	var D = date.getDate() < 10 ? '0' + date.getDate() : date.getDate();
	return Y + M + D;
	},
 //时分秒转化
 timestampToTime: function(timestamp) {
	var date = new Date(timestamp * 1000); //时间戳为10位需*1000，时间戳为13位的话不需乘1000
	var Y = date.getFullYear() + '/';
	var M = (date.getMonth() + 1 < 10 ? '0' + (date.getMonth() + 1) : date.getMonth() + 1) + '/';
	var D = date.getDate() < 10 ? '0' + date.getDate() + ' ' : date.getDate() + ' ';
	var h = date.getHours() < 10 ? '0' + date.getHours() + ':' : date.getHours() + ':';
	var m = date.getMinutes() < 10 ? '0' + date.getMinutes() + ':' : date.getMinutes() + ':';
	var s = date.getSeconds() < 10 ? '0' + date.getSeconds() : date.getSeconds();
		return Y + M + D + h + m + s;
}
//转化开始日期，结束日期参数
let date = getApp().globalData.timestampToYear(now / 1000);
let date2 = getApp().globalData.timestampToYear(now / 1000);
```

 ```js
checkTime: function(e, index) {
    let currentTime = index || e.currentTarget.dataset.id;
    let now = new Date(); //当前日期

    let nowDayOfWeek = now.getDay(); //今天本周的第几天

    let nowDay = now.getDate(); //当前日

    let nowMonth = now.getMonth(); //当前月

    let nowYear = now.getFullYear(); //当前年
    let date = ''
    let date2 = ''
    //add 增加判断今日订单 6点前
    if(currentTime == 1){
        let nowTime = new Date().getHours()
        if(nowTime >= 6){  //当前时间大于6点，正常取今日订单
            date = getApp().globalData.timestampToYear(now / 1000);
            date2 = getApp().globalData.timestampToYear(now / 1000);
        }else{  //当前时间小于早上6点 取前一天
            date = getApp().globalData.timestampToYear(new Date(nowYear, nowMonth, nowDay - 1) / 1000);
            date2 = getApp().globalData.timestampToYear(new Date(nowYear, nowMonth, nowDay - 1) / 1000);
        }
    }
    // let date = getApp().globalData.timestampToYear(now / 1000);
    // let date2 = getApp().globalData.timestampToYear(now / 1000);

    if (currentTime == 2) {
        console.log(new Date(nowYear, nowMonth, nowDay - nowDayOfWeek));
        date = getApp().globalData.timestampToYear(new Date(nowYear, nowMonth, nowDay - nowDayOfWeek) / 1000);
        date2 = getApp().globalData.timestampToYear(new Date(nowYear, nowMonth, nowDay + (6 - nowDayOfWeek)) / 1000);
    }
    //一个月订单
    if (currentTime == 3) {
        date = getApp().globalData.timestampToYear(new Date(nowYear, nowMonth, 1) / 1000);
        let day = new Date(new Date(nowYear, nowMonth, 28).getTime() + 28 * 24 * 3600 * 1000);
        day.setDate(0);
        date2 = getApp().globalData.timestampToYear(day / 1000);
    }
    //昨日订单
    if (currentTime == 4) {
        let nowTime = new Date().getHours()
        if(nowTime >= 6){  //增加6点时间段判断 正常取昨日订单
            date = getApp().globalData.timestampToYear(new Date(nowYear, nowMonth, nowDay - 1) / 1000);
            date2 = getApp().globalData.timestampToYear(new Date(nowYear, nowMonth, nowDay - 1) / 1000);
        }else{//小于6点时 start_time - 2 取前天
            date = getApp().globalData.timestampToYear(new Date(nowYear, nowMonth, nowDay - 2) / 1000);
            date2 = getApp().globalData.timestampToYear(new Date(nowYear, nowMonth, nowDay - 2) / 1000);
        }
        console.log(new Date(nowYear, nowMonth, nowDay - nowDayOfWeek));

    }
    this.setData(
        {
            currentTime: currentTime,
            date,
            date2,
            value:[date,date2],
            list:[],
            page:1
        },
        () => {
            this.getDetail();
            this.getOrder();
        }
    );
},
 ```





### 退出登陆逻辑

```js
outLogin: function() {
	let _this = this;
	getApp().globalData._get('passport/logout', {}, function(res) {
	let wxid = app.getWxappId()
	//退出登录时url显示wxid
	uni.reLaunch({
		url: `/pages/auth/auth?wxapp_id=${wxid}`
		});
	uni.removeStorageSync('sessionId');
	uni.removeStorageSync('authKey');
		});
},
```



### DDY显示等待时间计时

```js
//1. 获取返回数据 拿到返回的wait_time进行格式化，并重新赋值给对象属性formatWaitTime进行显示
res.data.data[i].formatWaitTime = _this.formatWaitTime(res.data.data[i].wait_time);
 _this.setData({
        orderList: res.data.data
      })
//2.调用定时器方法刷新数据
_this.interval(res.data.data)

//格式化等待时间方法 
/** 例：服务器返回15000Seconds
	h * 3600 + m * 60 + s = 15000
	4小时又600秒 == 4h:10m:00s
	hour = 15000 / 3600 = 4.16hour
	15000 % 3600 = 600  
	600 / 60 = 10
	被除数小于除数时，余数等于自己本身
	15000 % 86400 = 15000
	
	情况2： 当时间大于1天
	3600h + 60m + s = 100000
	h = 100000/3600 = 27.777 = 27
	余数= 100000%3600 = 2800s
*/
  formatWaitTime: function (second){
    let _this = this;
    var hours = Math.floor(second / 3600);
    var minutes = Math.floor(((second % 86400) % 3600) / 60);
    var seconds = Math.floor(((second % 86400) % 3600) % 60);
    return _this.formartData(hours) + ":" + _this.formartData(minutes) + ":" + _this.formartData(seconds);
  }, 
      
//定时器刷新方法
  interval: function(orderList){
     let _this = this;
    clearInterval(timer);
    timer=setInterval(function(){
        //遍历orderList,拿到里面的wait_time进行格式化赋值，并对该值++，定时器执行时就会更新页面
      for (let i = 0; i < orderList.length; i++) {
        orderList[i].formatWaitTime = _this.formatWaitTime(orderList[i].wait_time);
        orderList[i].wait_time++ 
      }
        //设置1000的计时，每隔1秒执行setData更新页面计时
      _this.setData({
        orderList: orderList
      })
    },1000)  
  }

```



### 加载下一页逻辑

```js
//获取售后管理列表
getRefundList(){
      let _this = this
      isLoading = true 
      let queryInfo = {
          status: -1,
          page: _this.page,
          list_rows: 20  
      }
      _this._get('order.refund/index', queryInfo, res => {
          console.log(res)
          let oldList = _this.refundList
          let newList = res.data.list.data || []
          isLoading = false

          _this.setData({
              refundList: [...oldList,...newList],
              //当前数组长度大于0,下次请求时page+1
              page: newList.length > 0 ? _this.page + 1 : _this.page
          })
      })
  },
  // 点击顶部tab,清空列表,重新获取数据
checkRefund(e){
  this.setData({
      currentSort: e.currentTarget.dataset.id,
      lists: [],
      refundList: [],
      page: 1,
  }, () => {
      this.getRefundList()
  })
},
 onReachBottom: function(){
     this.getRefundList()
 }
```



### 点餐首页的滚动逻辑

右侧菜单有2层页面，未滚动时显示一层，滚动时显示另外一层，通过**wx:if ={{!navFixed}}**判断

```html
<!-- bindscrolltolower="getNext"滚动到底部触发 没有写该方法-->
<!--scroll-top="{{scrollTop}}" 设置滚动条位置-->
<scroll-view scroll-top="{{scrollTop}}"  scroll-with-animation="true" bindscroll="onRightScroll" bindscrolltolower="getNext" wx:else class="right" scroll-y style="height:calc(100vh - 100rpx - env(safe-area-inset-bottom));">
</scroll-view>
```

```js
//滚动监听事件 
onRightScroll(e){
  let scrollTop = e.detail.scrollTop
  let $index = this.data.cateList.length -1;
  for(let i = 0;i<this.data.cateList.length;i++){
    if(this.data.cateTopInfo[this.data.cateList[i].category_id] >= scrollTop + 40){
      console.log(this.data.cateList[i].name)
      $index = i > 0 ? i -1 : 0
      break;
    }
  }
  this.setData({
    item_id:'item' + $index,
    selectedNav: $index,
    selectedNavId: this.data.cateList[$index].category_id,
  })
  },
      
 //左侧一级分类点击事件，右侧滑动到对应的菜品分类
checkNav: function (e) {
    let $index = e.currentTarget.dataset.index;
    let id = e.currentTarget.dataset.id;
    let _this = this;
    // this.getCateProduct(id);
    wx.pageScrollTo({  //调用官方方法滑动
      scrollTop: this.data.navHeight,
      duration: 300
    });
    this.setData({
      item_id:'item' + $index,
      isShowSelect:false,
      selectedNav: $index,
      selectedNavId: id,
      scrollTop:this.data.cateTopInfo[id]
    })
  },
```

### wx.createSelectorQuery()

```js
//返回一个 SelectorQuery 对象实例。在自定义组件或包含自定义组件的页面中，应使用 this.createSelectorQuery() 来代替。
const query = wx.createSelectorQuery()
query.select('#the-id').boundingClientRect()
query.selectViewport().scrollOffset()
query.exec(function(res){
  res[0].top       // #the-id节点的上边界坐标
  res[1].scrollTop // 显示区域的竖直滚动位置
})
```



### 圆形布局

核心思路：rotate 旋转

旋转中心点: transform-origin

```html
<view id="section_circle" class="circle-wrap">
		<view style="transform:rotate({{currentDegree}}deg)" data-center="{{circleCenter}}" class="circle-container" capture-bind:touchstart="{{m1.getStartLocation}}" capture-bind:touchend="{{m1.getEndLocation}}" catchtouchmove="{{m1.getMoveLocation}}">
			<view style="transform: rotate({{index * 360/circleLists.length}}deg)" class="circle-item" wx:for="{{circleLists}}" wx:key="index" data-index="{{index}}" bindtap="{{item.tap}}">
				<view data-index="{{index}}" class="circle-item-container {{(activeDegree % 360 + 360) % 360 - index * 360/circleLists.length >= -360/circleLists.length/2 && (activeDegree % 360 + 360) % 360 - index * 360/circleLists.length <= 360/circleLists.length/2 ? 'circle-active' : ''}}">
					<view class="point"></view>
					<view data-index="{{index}}" class="circle-item-text" style=" transform:rotate({{-index * 360/circleLists.length - currentDegree}}deg) ">
						<view>{{item.name }}
            <image src="/images/icon-new.gif" class="new-item" wx:if="{{item.name == '积分商城' && hasNewUpdate}}">
            </image></view>
						<view class="circle-item-text-en">{{item.name_en}}</view>
					</view>
				</view>
			</view>
		</view>
		<view class="circle-line">
		</view>
		<view class="coverBox"></view>
		<view class="circle-center">
			<image mode="aspectFill" src="{{imageUrl}}index-gif.gif?x-oss-process=image/resize,w_524"></image>
		</view>
	</view>
```



### transition属性

transition运用：图片hover时放大且有动画过渡的效果:

```css
img:hover {
    transform: scale(1.2)   //放大1.2倍， x,y轴一样放大倍数时，写一个参数即可
}
img {  
   transition: all .4s   //给img添加过渡效果
}
```



### mill大转盘(难点!)

```html
<view id="section_circle" class="circle-wrap">
    <view style="transform:rotate({{currentDegree}}deg)" data-center="{{circleCenter}}" class="circle-container" capture-bind:touchstart="{{m1.getStartLocation}}" capture-bind:touchend="{{m1.getEndLocation}}" catchtouchmove="{{m1.getMoveLocation}}">
        <view style="transform: rotate({{index * 360/circleLists.length}}deg)" class="circle-item" wx:for="{{circleLists}}" wx:key="index" data-index="{{index}}" bindtap="{{item.tap}}">
            <view data-index="{{index}}" class="circle-item-container {{(activeDegree % 360 + 360) % 360 - index * 360/circleLists.length >= -360/circleLists.length/2 && (activeDegree % 360 + 360) % 360 - index * 360/circleLists.length <= 360/circleLists.length/2 ? 'circle-active' : ''}}">
                <view class="point"></view>
                <view data-index="{{index}}" class="circle-item-text" style=" transform:rotate({{-index * 360/circleLists.length - currentDegree}}deg) ">
                    <view>{{item.name }}
        <image src="/images/icon-new.gif" class="new-item" wx:if="{{item.name == '积分商城' && hasNewUpdate}}">
        </image></view>
                    <view class="circle-item-text-en">{{item.name_en}}</view>
                </view>
            </view>
        </view>
    </view>
    <view class="circle-line">
    </view>
    <view class="coverBox"></view>
    <view class="circle-center">
        <image mode="aspectFill" src="{{imageUrl}}index-gif.gif?x-oss-process=image/resize,w_524"></image>
    </view>
</view>
<wxs module="m1" src="./move.wxs"></wxs>
```

```js
//move.wxs文件
var getPercent = function(index, perdegree, target) {
  var target = target % 360 >= 0 ? target % 360 : target % 360 + 360;
  if (index * perdegree <= target + perdegree && index * perdegree >= target - perdegree) {
    return (224 - 140) / 140 * (1 - Math.abs(index * perdegree - target) / 36)
  } else {
    return 0
  }

}

var n=0;
var showImageNo = 0 //当前展示图片猫序号
var degreeInfo = {
  startDegree: 18,
  currentDegree: 18,
  activeDegreeInit: 252,
  activeDegree: 252,
}
var circleCenter = {}
var startXY = {}
var endXY = {}
var listLength=10
//起始坐标
var getStartLocation = function (e, ownerInstance) {
  startXY = {
    x: e.touches[0].pageX,
    y: e.touches[0].pageY
  }
  circleCenter = e.currentTarget.dataset.center
  listLength =e.currentTarget.dataset.listLength
  var instance = ownerInstance.selectComponent('.cat-one')
  instance.setStyle({
    left:'270rpx'
  })
  var instance2 = ownerInstance.selectComponent('.cat-two')
  instance2.setStyle({
    left: '270rpx'
  })
  var instance3 = ownerInstance.selectComponent('.cat-three')
  instance3.setStyle({
    left: '270rpx'
  })
  var instance4 = ownerInstance.selectComponent('.cat-four')
  instance4.setStyle({
    left: '270rpx'
  })
  var instance5 = ownerInstance.selectComponent('.cat-five')
  instance5.setStyle({
    left: '270rpx'
  })
  var instance6 = ownerInstance.selectComponent('.cat-six')
  instance6.setStyle({
    left: '270rpx'
  })
}
//结束时的坐标
var getEndLocation = function(e, ownerInstance) {
  endXY = {
    x: e.changedTouches[0].pageX,
    y: e.changedTouches[0].pageY
  }
  var degree = getCurrentDegree(circleCenter, startXY, endXY);
  var perDegree = 360 / 10;
  if (degree % perDegree > perDegree / 2) {
    degree = degree - degree % perDegree + perDegree
  } else {
    degree = degree - degree % perDegree
  }

  degreeInfo = {
    currentDegree: degreeInfo.startDegree + degree,
    startDegree: degreeInfo.startDegree + degree,
    activeDegreeInit: degreeInfo.activeDegreeInit - degree,
    activeDegree: degreeInfo.activeDegreeInit - degree,
  }
  console.log(JSON.stringify(degreeInfo))
  var instance = ownerInstance.selectComponent('.circle-container')
  instance.setStyle({
    "transform": "rotate(" + degreeInfo.currentDegree + "deg)"
  })
  var instance2 = ownerInstance.selectAllComponents('.circle-item-container')
  instance2.forEach(function(item) {
    if ((degreeInfo.activeDegree % 360 + 360) % 360 - item.getDataset().index * 360 / instance2.length >= -360 / instance2.length / 2 && (degreeInfo.activeDegree % 360 + 360) % 360 - item.getDataset().index * 360 / instance2.length <= 360 / instance2.length / 2) {
     
      item.addClass('circle-active')
    } else {
      if (item.hasClass('circle-active')) {
        item.removeClass('circle-active')
      }
    }
    
    item.setStyle({
      // "transform": "scale(" + (1 + getPercent(item.getDataset().index, 360 / instance2.length, degreeInfo.activeDegree)) + ")"
    })
  })
  //管凯旋add
  // var instance10 = ownerInstance.selectAllComponents('.circle-item')
  // instance10.forEach(function (item) {
  //   if ((degreeInfo.activeDegree % 360 + 360) % 360 - item.getDataset().index * 360 / instance10.length >= -360 / instance10.length && (degreeInfo.activeDegree % 360 + 360) % 360 - item.getDataset().index * 360 / instance10.length <= 360 / instance10.length ) {
  //     item.addClass('circle-item-active')
  //   } else {
  //     if (item.hasClass('circle-item-active')) {
  //       item.removeClass('circle-item-active')
  //     }
  //   }
  // })
  //管凯旋end
  var instance3 = ownerInstance.selectAllComponents('.circle-item-text')
  instance3.forEach(function(item) {
    item.setStyle({
      "transform": "rotate(" + (-item.getDataset().index * 360 / instance3.length - degreeInfo.currentDegree) + "deg)"
    })
  })
  if(showImageNo == 0){
    var instance4 = ownerInstance.selectComponent('.cat-two')
    instance4.setStyle({
      left: '0rpx'
    })
    showImageNo = 1
  } else if (showImageNo == 1){
    var instance5 = ownerInstance.selectComponent('.cat-one')
    instance5.setStyle({
      left: '0rpx'
    })
    showImageNo = 2
  } else if (showImageNo == 2) {
    var instance6 = ownerInstance.selectComponent('.cat-three')
    instance6.setStyle({
      left: '0rpx'
    })
    showImageNo = 3
  } else if (showImageNo == 3) {
    var instance7 = ownerInstance.selectComponent('.cat-four')
    instance7.setStyle({
      left: '0rpx'
    })
    showImageNo = 4
  } else if (showImageNo == 4) {
    var instance8 = ownerInstance.selectComponent('.cat-five')
    instance8.setStyle({
      left: '0rpx'
    })
    showImageNo = 5
  } else if (showImageNo == 5) {
    var instance9 = ownerInstance.selectComponent('.cat-six')
    instance9.setStyle({
      left: '0rpx'
    })
    showImageNo = 0
  }
  
}
//移动时的坐标
var getMoveLocation = function (e, ownerInstance) {
  endXY = {
    x: e.changedTouches[0].pageX,
    y: e.changedTouches[0].pageY
  }
  var degree = getCurrentDegree(circleCenter, startXY, endXY);
  degreeInfo.currentDegree = degreeInfo.startDegree + degree
 degreeInfo.activeDegree = degreeInfo.activeDegreeInit - degree;
 
  var instance = ownerInstance.selectComponent('.circle-container')
  instance.setStyle({
    "transform": "rotate(" + degreeInfo.currentDegree + "deg)"
  })
  var instance2 = ownerInstance.selectAllComponents('.circle-item-container')
  instance2.forEach(function (item) {
    if ((degreeInfo.activeDegree % 360 + 360) % 360 - item.getDataset().index * 360 / instance2.length >= -360 / instance2.length / 2 && (degreeInfo.activeDegree % 360 + 360) % 360 - item.getDataset().index * 360 / instance2.length <= 360 / instance2.length / 2) {
      item.addClass('circle-active')
    } else {
      if (item.hasClass('circle-active')) {
        item.removeClass('circle-active')
      }
    }
    item.setStyle({
      // "transform": "scale(" + (1 + getPercent(item.getDataset().index, 360 / instance2.length, degreeInfo.activeDegree)) + ")"
    })
  })
  //管凯旋add
  // var instance10 = ownerInstance.selectAllComponents('.circle-item')
  // instance10.forEach(function (item) {
  //   if ((degreeInfo.activeDegree % 360 + 360) % 360 - item.getDataset().index * 360 / instance10.length >= -360 / instance10.length/2 && (degreeInfo.activeDegree % 360 + 360) % 360 - item.getDataset().index * 360 / instance10.length <= 360 / instance10.length/2 ) {
  //     item.addClass('circle-item-active')
  //   } else {
  //     if (item.hasClass('circle-item-active')) {
  //       item.removeClass('circle-item-active')
  //     }
  //   }
  // })
  //管凯旋end
  var instance3 = ownerInstance.selectAllComponents('.circle-item-text')
  instance3.forEach(function (item) {
    item.setStyle({
      "transform": "rotate(" + (-item.getDataset().index * 360 / instance3.length - degreeInfo.currentDegree) + "deg)"
    })
  })

}
//获得角度
var getCurrentDegree = function(centerXY, startXY, endXY) {
  //起始点距离圆心距离
  var startDistanceCenter = Math.sqrt(Math.pow(Math.abs(startXY.x - centerXY.x), 2) + Math.pow(Math.abs(startXY.y - centerXY.y), 2))
  //结束点距离圆心距离
  var endDistanceCenter = Math.sqrt(Math.pow(Math.abs(endXY.x - centerXY.x), 2) + Math.pow(Math.abs(endXY.y - centerXY.y), 2))
  //起始点距离结束点距离
  var startDistanceEnd = Math.sqrt(Math.pow(Math.abs(startXY.x - endXY.x), 2) + Math.pow(Math.abs(startXY.y - endXY.y), 2));
  var degree = Math.acos((endDistanceCenter * endDistanceCenter + startDistanceCenter * startDistanceCenter - startDistanceEnd * startDistanceEnd) / (2 * endDistanceCenter * startDistanceCenter)) / Math.PI * 180;
  var isClockwise2 = isClockwise(centerXY, startXY, endXY) ? 1 : -1;
  degree = isClockwise2 * degree;
  // console.log("是否顺时针", degree)
  if (centerXY.x - startXY.x < 0 && centerXY.x - endXY.x < 0) {
    // console.log("x区域")
    return 0
  }
  if (centerXY.y - startXY.y > 0 && centerXY.y - endXY.y > 0) {
    // console.log("-xy区域")
    if (startXY.y - endXY.y > 0 && startXY.x - endXY.x > 0) {
      // console.log("totopleft")
      return 0;
    }
    if (startXY.y - endXY.y < 0 && startXY.x - endXY.x < 0) {
      // console.log("tobottomright")
      return 0;
    }
  }
  if (centerXY.y - startXY.y < 0 && centerXY.y - endXY.y < 0) {
    // console.log("-x-y区域")
    if (startXY.y - endXY.y > 0 && startXY.x - endXY.x < 0) {
      // console.log("totopright")
      return 0;
    }
    if (startXY.y - endXY.y < 0 && startXY.x - endXY.x > 0) {
      // console.log("tobottomleft")
      return 0;
    }
  }
  return degree
}
//判断顺逆时针
var isClockwise = function(circleCenter, startXY, endXY) {
  var startX = startXY.x - circleCenter.x;
  var startY = startXY.y - circleCenter.y;
  var endX = endXY.x - circleCenter.x;
  var endY = endXY.y - circleCenter.y;
  if (endX - startX > 0) {
    if (endY - startY > 0) {
      return false
    } else {
      return true
    }
  } else {
    if (endY - startY > 0) {
      return false
    } else {
      return true
    }
  }
}
module.exports = {
  getPercent: getPercent,
  getStartLocation: getStartLocation,
  getEndLocation: getEndLocation,
  getMoveLocation: getMoveLocation,
  degreeInfo: degreeInfo,
  n:n
}
```



### mill快捷导航小组件

```html
<view class="shortcut" style="right: {{ right }}; bottom: {{ bottom }};">

  <!-- 首页 -->
  <form bindsubmit="_onTargetPage" report-submit="true">
    <button formType="submit" data-index="0" class="nav-item btn-normal {{ isShow ? 'show_80' : (transparent ? '' : 'hide_80') }}">
      <text class="iconfont icon-home"></text>
    </button>
  </form>

  <!-- 分类页 -->
  <form bindsubmit="_onTargetPage" report-submit="true">
    <button formType="submit" data-index="1" class="nav-item btn-normal {{ isShow ? 'show_60' : (transparent ? '' : 'hide_60') }}">
      <text class="iconfont icon-cate"></text>
    </button>
  </form>

  <!-- 购物车 -->
  <form bindsubmit="_onTargetPage" report-submit="true">
    <button formType="submit" data-index="2" class="nav-item btn-normal {{ isShow ? 'show_40' : (transparent ? '' : 'hide_40') }}">
      <text class="iconfont icon-cart"></text>
    </button>
  </form>

  <!-- 个人中心 -->
  <form bindsubmit="_onTargetPage" report-submit="true">
    <button formType="submit" data-index="3" class="nav-item btn-normal {{ isShow ? 'show_20' : (transparent ? '' : 'hide_20') }}">
      <text class="iconfont icon-profile"></text>
    </button>
  </form>

  <!-- 显示隐藏开关 -->
    <!-- 
     导航菜单切换事件
    _onToggleShow(e) {
      // 记录formid
      App.saveFormId(e.detail.formId);
      this.setData({
        isShow: !this.data.isShow,
        transparent: false
      })
    },-->
  <form bindsubmit="_onToggleShow" report-submit="true">
    <button formType="submit" class="nav-item nav-item__switch btn-normal {{ isShow ? 'shortcut_click_show' : '' }}">
      <text class='iconfont icon-daohang'></text>
    </button>
  </form>

</view>
```

```css
@import "/utils/common.wxss";

/* 快捷导航 */

.shortcut {
  position: fixed;
  right: 24rpx;
  bottom: 250rpx;
  width: 76rpx;
  line-height: 1;
  z-index: 5;
  border-radius: 50%;
}

/* 导航菜单元素 */

.nav-item {
  position: absolute;
  bottom: 0;
  padding: 0;
  width: 76rpx;
  height: 76rpx;
  line-height: 76rpx;
  color: #fff;
  background: rgba(0, 0, 0, 0.4);
  border-radius: 50%;
  text-align: center;
  transform: rotate(0deg);
  opacity: 0;
}

.nav-item text {
  font-size: 40rpx;
}

/* 导航开关 */

.nav-item__switch {
  opacity: 1;
}

.shortcut_click_show {
  margin-bottom: 0;
  background: #ff5454;
}

/* 显示动画 */

.show_80 {
  bottom: 384rpx;
  animation: show_80 0.3s forwards;
}

.show_60 {
  bottom: 288rpx;
  animation: show_60 0.3s forwards;
}

.show_40 {
  bottom: 192rpx;
  animation: show_40 0.3s forwards;
}

.show_20 {
  bottom: 96rpx;
  animation: show_20 0.3s forwards;
}

@keyframes show_20 {
  from {
    bottom: 0;
    transform: rotate(0deg);
    opacity: 0;
  }

  to {
    bottom: 96rpx;
    transform: rotate(360deg);
    opacity: 1;
  }
}

@keyframes show_40 {
  from {
    bottom: 0;
    transform: rotate(0deg);
    opacity: 0;
  }

  to {
    bottom: 192rpx;
    transform: rotate(360deg);
    opacity: 1;
  }
}

@keyframes show_60 {
  from {
    bottom: 0;
    transform: rotate(0deg);
    opacity: 0;
  }

  to {
    bottom: 288rpx;
    transform: rotate(360deg);
    opacity: 1;
  }
}

@keyframes show_80 {
  from {
    bottom: 0;
    transform: rotate(0deg);
    opacity: 0;
  }

  to {
    bottom: 384rpx;
    transform: rotate(360deg);
    opacity: 1;
  }
}

/* 隐藏动画 */

.hide_80 {
  bottom: 0;
  animation: hide_80 0.3s;
  opacity: 0;
}

.hide_60 {
  bottom: 0;
  animation: hide_60 0.3s;
  opacity: 0;
}

.hide_40 {
  bottom: 0;
  animation: hide_40 0.3s;
  opacity: 0;
}

.hide_20 {
  bottom: 0;
  animation: hide_20 0.3s;
  opacity: 0;
}

@keyframes hide_20 {
  from {
    bottom: 96rpx;
    transform: rotate(360deg);
    opacity: 1;
  }

  to {
    bottom: 0;
    transform: rotate(0deg);
    opacity: 0;
  }
}

@keyframes hide_40 {
  from {
    bottom: 192rpx;
    transform: rotate(360deg);
    opacity: 1;
  }

  to {
    bottom: 0;
    transform: rotate(0deg);
    opacity: 0;
  }
}

@keyframes hide_60 {
  from {
    bottom: 288rpx;
    transform: rotate(360deg);
    opacity: 1;
  }

  to {
    bottom: 0;
    transform: rotate(0deg);
    opacity: 0;
  }
}

@keyframes hide_80 {
  from {
    bottom: 384rpx;
    transform: rotate(360deg);
    opacity: 1;
  }

  to {
    bottom: 0;
    transform: rotate(0deg);
    opacity: 0;
  }
}

```



### mill选择优惠券

```js
selectCoupon: function(e) {
				let idx = e.detail.value;
				this.is_user_grade = 0
				this.discountRatio = 1
				this.discountExtra = 0
				this.manual_order_discount_ratio_index = 0
				this.setData({
						selectCouponId: this.order.coupon_list[idx].user_coupon_id,
						selectCouponName: this.order.coupon_list[idx].name
					},
					() => {
						this.getCoupons(this.id); //传入订单id
					}
				);
			},
  //获取订单信息
 getCoupons: function(id) {
				let _this = this;
				getApp().globalData._get(
					'catering.order.order/checkOut', {
						is_user_grade: _this.is_user_grade,
						order_id: id,
						discountRatio: _this.manual_order_discount_ratio_index > 0 ?
							_this.discountRatioArr[_this.manual_order_discount_ratio_index].discount_ratio : _this
							.discountRatio.toFixed(2),
						service_fee_ratio: _this.serviceFeeArr[_this.service_fee_arr_index].ratio || 0,
						coupon_id: _this.selectCouponId,
						payType: _this.choosePayType,
						erase_zero: _this.erase_zero + 0,
						pay_mix: _this.choosePayType == 1000 ? JSON.stringify(this.pay_mix) : '',
						//酒水折扣
						// manual_order_discount_ratio: _this.manual_order_discount_ratio_index > 0 ?  _this.discountRatioArr[_this.manual_order_discount_ratio_index].discount_ratio : 1,
						catering_discount_id: _this.manual_order_discount_ratio_index > 0 ? _this.discountRatioArr[
							_this.manual_order_discount_ratio_index].id : '',
						//其他折扣
						extra_order_discount: _this.extra_order_discount_index > 0 ? _this.discountExtraArr[_this
							.extra_order_discount_index].cut_value : 0,
						extra_order_discount_text: _this.extra_order_discount_index > 0 ? _this.discountExtraArr[
							_this.extra_order_discount_index].name : 0,
						extra_order_discount_price: _this.extra_order_discount_index > 0 ? _this.discountExtraArr[
							_this.extra_order_discount_index].price : 0,
						extra_order_discount_id: _this.extra_order_discount_index > 0 ? _this.discountExtraArr[
							_this.extra_order_discount_index].id : '',
						user_card_id: _this.user_card_id || '',
					},
					function(res) {
                        //拿到优惠券数据，并在优惠券数组前加一个元素，'不使用优惠券'
						let no_coupon = {
							user_coupon_id: '',
							name: '不使用优惠券'
						};
						res.data.coupon_list.unshift(no_coupon);
						_this.order = res.data;
						//再请求订单详情
						_this.getOrderDetail(_this.id);
					}
				);
			},
  
   getOrderDetail: function(id) {
				let _this = this;
				getApp().globalData._get(
					'catering.order.order/detail', {
						order_id: id,
						orderType: 'incomplete'
					},
					function(res) {
						if (res.data.seat && res.data.seat.open_time) {
							res.data.seat.open_time = getApp().globalData.timestampToTime(res.data.seat.open_time);
						}
						if (res.data.pay_status.value == 20 || res.data.pay_status.value == 30) {
							uni.redirectTo({
								url: '/pages/orderFinished/orderFinished?id=' + res.data.order_id
							});
						}
						_this.setData({
							detail: res.data,
							user_id: res.data.user_id
						}, () => {
							if (res.data.seat.is_member > 0) {
								_this.getUserCard()
							}
						});
						res.data.goods.map(v => {
							_this.order.goods_list.map(v2 => {
								if (v.order_goods_id == v2.order_goods_id) {
									v.total_pay_price = v2.total_pay_price
								}
							})
						})
						_this.initListInfo(res.data.goods);
						_this.interval(res.data.wait_time);
					}
				);
			},
```



### mill优惠券多选-实现

```vue
<view class="section-coupon-info" @click="openCheckCoupon"
    v-if="order.user && order.coupon_list && order.coupon_list.length > 1"
    :style="selectCouponName == '不使用优惠券' ? 'filter:grayscale(100%)' : ''">
    {{ selectCouponName || '请选择优惠券' }}
</view>
<!-- 根据$refs弹出 -->
<uni-popup ref='checkCoupon'>
    <view class="pop-wrap1 ">
        <!-- 选择优惠券监听事件 -->
        <checkbox-group @change="checkboxChange">
            <label v-for="(item,index) in order.coupon_list" :key="index">
                <view>
                    <!--传点击的索引过去 此处必须转成字符串传递才不会报错 -->
                    <checkbox :value="String(index)" :checked="item.checked" />
                    <text>{{item.name}}</text>
                </view>

            </label>
        </checkbox-group>
        <view class="panel-around mt50 pop-btns">
            <view class="btn-cancel" @tap="cancelCoupon">取消</view>
            <view class="btn-confirm" @tap="confirmCoupon">确认</view>
        </view>
    </view>
</uni-popup>
<script>
//多选优惠券监听事件
checkboxChange(e) {
    let _this = this
    console.log(e)
    //选中的优惠券数组的索引
    let chooseIdx = e.detail.value
    this.is_user_grade = 0
    this.discountRatio = 1
    this.discountExtra = 0
    this.manual_order_discount_ratio_index = 0
    //不使用优惠券情况
    //使用for循环return才有效, 别用forEach  
    for (let i = 0; i < chooseIdx.length; i++) {
        if (chooseIdx[i] === '0') {
            _this.$refs.checkCoupon.close()
            _this.setData({
                selectCouponName: _this.order.coupon_list[0].name,
                selectCouponId: ''
            }, () => {
                _this.getCoupons(this.id) //不使用优惠券也要调用刷新页面
            })
            console.log('执行return')
            return
        } else {
            //根据点击索引获取对应的优惠券名称和id
            console.log('执行了下面语句')
            let chooseName = chooseIdx.map(item => {
                return _this.order.coupon_list[item].name
            }).toString()
            let chooseId = chooseIdx.map(item => {
                return _this.order.coupon_list[item].user_coupon_id
            }).toString()
            console.log('优惠券名:', chooseName + '////优惠券id:', chooseId)
            _this.setData({
                selectCouponId: chooseId,
                selectCouponName: chooseName
            })
        }
    }
  
},
</script>
```



### mill并桌-实现

```vue
<template>
<text style="text-decoration: underline;white-space: nowrap;" 								  @click="openNewPlusSeatPop">
	{{ detail.seat_category_name }} {{ detail.seat_name }}
</text>
<uni-popup ref="plusSeatPopup">
    <view class="pop-wrap" style="background-color: #F1F1F6;">
        <view class="pop-close">
            <text>桌位操作</text>
            <image @tap="closePlusSeatPop" class="close"
                   src="/static/images/close.png"></image>
        </view>
        <view class="plus-op">
            <!-- 进入换桌流程 -->
            <view class="plus-item" @tap="newOpenChangeSeatPop">换桌</view>
            <!-- 进入并台流程 -->
            <view class="plus-item" @tap="newMergeSeatPop">并台</view>
        </view>
    </view>
</uni-popup>
<!-- 新增 并台弹窗 获取桌位列表-->
<uni-popup ref="changeSeatPopup2">
    <view class="pop-wrap" v-if="showChangeSeat" style="background-color: #F1F1F6;">
        <view class="pop-close">
            <text>并台</text>
            <image @tap="closeChangeSeatPop" 
                   class="close" src="/static/images/close.png"></image>
        </view>
        <scroll-view scroll-y="true" style="height: 50vh;">
            <view class="section-right-cates">
                <view :class="['section-right-cate', { 'section-right-cate-active': category_id == 0 }]"
                    @click="changeTab(0)">
                    <view><text>全部区域</text></view>
                </view>
                <view
                    :class="['section-right-cate', { 'section-right-cate-active': category_id == item.category_id }]"
                    @click="changeTab(item.category_id)"
                    v-for="(item, index) in category"
                    v-if="item.count > 0">
                    <view>
                        <text>{{ item.name }}</text>
                    </view>
                </view>
            </view>
            <view class="seat-items">
                <template v-for="(item, index) in category" v-if="item.count > 0">
                    <template class="seat-items" 
                              v-if="category_id == 0 || category_id == item.category_id">

                        <!-- 使用新增的并桌组件 触发并桌条件判断openMergeSeat  -->
                        <seat-item2 :width="0.31" v-for="(ite, idx) in list"
                            @click.native="openMergeSeat(ite.seat_id, ite.order_id, ite)"
                            :category_name="item.name" :seat="ite" 
                            v-if="item.category_id == ite.category_id">
                        </seat-item2>
                    </template>
                </template>
                <view class="seat-item-none"></view>
                <view class="seat-item-none"></view>
                <view class="seat-item-none"></view>
            </view>
        </scroll-view>
        <view class="panel-around mt50 pop-btns">
            <view class="btn-cancel" @tap="closeChangeSeatPop">取消</view>
            <!-- 二次并桌弹窗开关 -->
            <view class="btn-confirm" @tap="mergeSeatOpen">确认并台</view>
        </view>
    </view>
</uni-popup>
<!-- 并桌二次确认弹窗 显示要并的桌位和当前桌位，以及箭头图标-->
<uni-popup ref="mergeSecond">
    <view class="pop-wrap">
        <view class="pop-close">
            <text>请确认并台信息,确认后无法取消</text>
            <image @tap="closemergeSecond" class="close" 
                   src="/static/images/close.png"></image>
        </view>
        <view class="merge-info">
            <!-- 当前桌位 -->
            <view class="merge-item">
                <seat-single :width="0.31" :seat="currentSeatInfo"></seat-single>
            </view>
            <!-- 箭头图 -->
            <view class="merge-item">
                <image src="/static/images/arrow.png" mode="aspectFit"></image>
            </view>
            <!-- 要并的桌位 -->
            <view class="merge-item">
                <!-- 把获取到的mergeInfo桌数据传递给子组件 -->
                <seat-single :width="0.31" :seat="mergeInfo"></seat-single>
            </view>
        </view>
        <view class="panel-around mt50 pop-btns">
            <view class="btn-cancel" @tap="closemergeSecond">取消</view>

            <view class="btn-confirm" @tap="mergeFinalConfirm">确认并台</view>
        </view>
    </view>
</uni-popup>
</template>


<script>
data: {
    return {
        mergeInfo: '',      //并桌对象
		currentSeatInfo: '' //当前桌位
    }
}
methods: {
 //增加 新并桌+换桌弹窗
openNewPlusSeatPop() {
  this.$refs.plusSeatPopup.open()
},    
//新入口->并台弹窗 桌位列表
newMergeSeatPop() {
    this.$refs.plusSeatPopup.close()
    this.$refs.changeSeatPopup2.open();
    this.getSeat();
    this.showChangeSeat = true;
},
//！关键新增 选择要并桌的桌位触发相关提示，并获取新桌和原桌数据
//传入选择的桌位id，订单id, 桌位信息本身
openMergeSeat(seat_id, order_id, seat) {
    if (seat.status.value == 0) {
        uni.showToast({
            title: '空桌无法并台,请使用换桌功能',
            icon: 'none'
        })
        return
    }
    if (seat.status.value == 3) {
        uni.showToast({
            title: '该桌位已结账,无法并台',
            icon: 'none'
        })
        return
    }
    //1.遍历list拿到当前的桌位数据,用于并桌二次确认渲染
    this.list.forEach(v => {
        if (v.seat_id == this.detail.seat_id) {
            this.currentSeatInfo = v
        }
    })
    this.list.map(v2 => {
        if (seat_id == v2.seat_id) {
            v2.is_check = true;
            this.mergeInfo = v2 //2.拿到要并台的桌位数据
        } else {
            v2.is_check = false;
        }
    });
    this.seat_id = seat_id; //保存选择的座位id 

},
//并台二次确认弹窗 
mergeSeatOpen() {
    if(!this.currentSeatInfo|| !this.mergeInfo){
        uni.showToast({
            icon: 'none',
            title: '请选择要并台的桌位'
        })
        return
    }
    if(this.currentSeatInfo.seat_id == this.mergeInfo.seat_id){
        uni.showToast({
            icon: 'none',
            title: '不能选择自己桌位'
        })
        return
    }
    this.$refs.mergeSecond.open()
},
 //最终并台操作，调接口
mergeFinalConfirm(){
    let _this = this;
    getApp().globalData._post_form(
        'catering.order.order/mergeSeat', {
            guest_seat_id: _this.seat_id,
            order_id: _this.id,
            master_seat_id: _this.detail.seat_id 
        },
        res => {
            console.log(res);
            uni.showToast({
                title: '并台成功',
                icon: 'none',
                mask: true
            });
            _this.currentSeatInfo = ''
            _this.mergeInfo = ''
            _this.getOrderDetail(_this.id);
            _this.getCoupons(_this.id);
            //关闭两个弹窗
            _this.closeChangeSeatPop() 
            _this.closemergeSecond()
        },
        null,
        () => {
            uni.hideLoading();
        }
    );
},   
}

</script>
```



### uni-popup用法

```html
<!--并桌二次确认弹窗-->
<uni-popup ref="mergeSecond">
    <view class="pop-wrap">
        <view class="pop-close">
            <text>请确认并台信息,确认后无法取消</text>
            <image @tap="closemergeSecond" class="close" src="/static/images/close.png"></image>
        </view>
        <view class="merge-info">
            <!-- 当前桌位 -->
            <view class="merge-item">
                <seat-single :width="0.31" :seat="currentSeatInfo"></seat-single>
            </view>
            <!-- 箭头图 -->
            <view class="merge-item">
                <image src="/static/images/arrow.png" mode="aspectFit"></image>
            </view>
            <!-- 要并的桌位 -->
            <view class="merge-item">
                <!-- 把获取到的mergeInfo桌数据传递给子组件 -->
                <seat-single :width="0.31" :seat="mergeInfo"></seat-single>
            </view>
        </view>
        <view class="panel-around mt50 pop-btns">
            <view class="btn-cancel" @tap="closemergeSecond">取消</view>

            <view class="btn-confirm" @tap="mergeFinalConfirm">确认并台</view>
        </view>
    </view>
</uni-popup>
```

```css
.pop-wrap {
    padding: 16px;
    width: 600px;
    background: #ffffff;
    border-radius: 16px;

    font-size: 24px;
    font-family: PingFangSC-Medium, PingFang SC;
    font-weight: 500;
    color: #282635;
	}
```

### 日历的实现

![image-20210608101841828](C:\Users\HP ProDesk\AppData\Roaming\Typora\typora-user-images\image-20210608101841828.png)

```html
<view class="sign-calendar-wrap">
    <view class="date-text">{{ today_year }}/{{ today_month }}</view>
    <view class="week-list">
        <view class="week-item"
              v-for="(item, index) in weeklist" 
              :key="index">{{ item }}
        </view>
    </view>
    <view class="date-list-wrap">
        <view class="date-item"
              :class="item.type != 0 ? 'secondary-date-item' : ''" 
              v-for="(item, index) in daylist" :key="index">
            <text v-if="list.indexOf(item.day) > -1 && item.type == 0"
                  class="icon-box">{{ item.day }}</text>
            <template>
                <text class="iconfont icon-libao" 
                      v-if="reward.indexOf(item.day - today) > -1 && item.type == 0 && list.indexOf(item.day) == -1"></text>
                <view v-if="list.indexOf(item.day) == -1 && item.type == 0 && reward.indexOf(item.day - today) == -1">
                    <text>{{ item.day }}</text>
                </view>
            </template>
        </view>
    </view>
</view>
```



### 富文本转码

```js
getInfos() {
    let that = this;
    app._get('?s=/api/activity.index/detail', {
      activity_id: that.data.activity_id,
    }, (res) => {
      console.log(res, 952)
      // 富文本转码
      if (res.data.detail.detail.length > 0) {
        let str = res.data.detail.detail; //获取到的富文本信息
        str = str.replace(/&lt;/g, '<');
        str = str.replace(/&gt;/g, '>');
        str = str.replace(/&quot;/g, '"');
        str = str.replace(/&amp;/g, '&');
        str = app.replaceDetail(str);
        res.data.detail.detail = str;
      }
      let arr = [];
      arr = res.data.setting.tags && res.data.setting.tags.split(',');
      that.setData({
        info: res.data,
        popupTips: arr,
        photoList: res.data.detail.images,
        videoList: res.data.detail.videos,
        read_count: res.data.detail.read_count
      })
    })
  },
      
 //相关样式转码
 replaceDetail (details) {

    var texts = '';//待拼接的内容

    while (details.indexOf('<img') != -1) {//寻找img 循环

      texts += details.substring('0', details.indexOf('<img') + 4);//截取到<img前面的内容

      details = details.substring(details.indexOf('<img') + 4);//<img 后面的内容

      if (details.indexOf('style=') != -1 && details.indexOf('style=') < details.indexOf('>')) {

        texts += details.substring(0, details.indexOf('style="') + 7) + "max-width:100%;height:auto;margin:0 auto;";//从 <img 后面的内容 截取到style= 加上自己要加的内容

        details = details.substring(details.indexOf('style="') + 7); //style后面的内容拼接

      } else {

        texts += ' style="max-width:100%;height:auto;margin:0 auto;" ';

      }
```



### 惠彩小店根据时间段进行开关判断

```js
//传入时间点，根据当前时间判断是否可约明天 
//this.checkAuditTime("16:30","23:59")
checkAuditTime(beginTime, endTime) {
    var nowDate = new Date();
    var beginDate = new Date(nowDate);
    var endDate = new Date(nowDate);
    var beginIndex = beginTime.lastIndexOf("\:");
    var beginHour = beginTime.substring(0, beginIndex); //16
    var beginMinue = beginTime.substring(beginIndex + 1, beginTime.length); //30
    //设置当天的小时: setHours(h,min,sec,milsec)
    beginDate.setHours(beginHour, beginMinue, 0, 0);

    var endIndex = endTime.lastIndexOf("\:");
    var endHour = endTime.substring(0, endIndex);
    var endMinue = endTime.substring(endIndex + 1, endTime.length);
    endDate.setHours(endHour, endMinue, 0, 0);

    //判断当前时间是否在设置的时间段内，是的话返回true
    if (nowDate.getTime() - beginDate.getTime() >= 0 && nowDate.getTime() <= endDate.getTime()) {
      return 1;
    } else {
      return 0;
    }
 },
```



### mill年月日转换

```js
timestampToYear: function(timestamp) {
    var date = new Date(timestamp * 1000); //时间戳为10位需*1000，时间戳为13位的话不需乘1000
    var Y = date.getFullYear() + '-';
    var M = (date.getMonth() + 1 < 10 ? '0' + (date.getMonth() + 1) : date.getMonth() + 1) + '-';
    var D = date.getDate() < 10 ? '0' + date.getDate() : date.getDate();
    return Y + M + D;
},
```





### 善语服务端 快捷备注

```html
<!--添加快捷备注的弹窗-->
<text>添加标签</text><input type="text" placeholder="请输入标签内容" @input="onTagInput" :value="tagInputText"></input>
<view class="pop-btns">
    <view class="pop-btn-cancel" @tap="handleClose">
      取消
    </view>
    <view class="pop-btn-confirm" @tap="addTag">
      确认
    </view>
    
  <!--渲染快捷备注的容器-->
 <view class="order-item-tags">
    <view v-for="(item, index) in tags" :key="index">{{item}} <text style="color:#FE2A1E" @tap="deleteTag" :data-index="index">删除</text> </view> <view @tap="showAddTagPop">+ 添加标签</view>
  </view>
```

```js
onTagInput(e) {
  this.setData({
    tagInputText: e.detail.value
  });
},
 
  //把输入的备注显示到界面上
 addTag() {
      let tags = this.tags;
      if (!this.tagInputText) {
        uni.showToast({
          title: '请输入内容',
          icon: 'none'
        });
        return;
      }
      tags.push(this.tagInputText);
      this.setData({
        tags,
        addTagPop: false,
        tagInputText: ''
      });
    },

```



### 牛者input快捷备注

```html
<input value="{{form.remark}}"
       class='pop-code-input' 
       bindinput='handleTextarea' maxlength='50' 
       placeholder-class='placeholder' placeholder="请填写您的特殊需求，我们将会尽量满足！"></input>
<!-- 可选择的快捷备注 -->
<view class='pop-code-last'>
    <view wx:for="{{popText}}" 
          catchtap='handleRemark' data-item="{{item}}" 
          wx:if="{{item}}" wx:key="*this">
        {{item}}
    </view>
</view>
```

```js
//输入备注
handleTextarea: function (e) {
    console.log(e.detail.value)
    let form = this.data.form
    form.remark = e.detail.value
    this.setData({
      form: form
    })
  },
// 选择快捷备注
handleRemark: function (e) {
    let form = this.data.form
    //获取form.remark中数据，若有remark，则对字符串拼接
    if (form.remark) { 
      form.remark = form.remark + '，' + e.currentTarget.dataset.item
    } else {
       //remark为空，直接显示点击的备注
      form.remark = e.currentTarget.dataset.item
    }
    this.setData({
      form: form
    })
},
```



### 惠彩 横向日期容器实现逻辑

```html
<view class="scroll">
<scroll-view scroll-x="true" 
             scroll-into-view="{{toView}}" 
             scroll-left="{{scrollTop}}">
    <view class="scroll-x">
        <view id="{{'item' + index}}" 
              class="fo-32 scroll-view-item" 
              wx:for="{{arrDay}}" wx:key="index" 
              wx:if="{{item.day - dayNow  != 0}}">
            <view id="{{'item' + index}}" 
                  wx:if="{{item.day - dayNow  == 0}}" 
                  class="{{active==(index) ? 'on' : ''}}" 
                  bindtap="changeTab" data-id="{{index}}">
                今天
                <view class="fo-24">{{ item.week }}</view>
            </view>
            <view id="{{'item' + index}}" 
                  wx:elif="{{item.day - dayNow == 1}}" 
                  class="{{active==(index) ? 'on' : ''}}" 
                  bindtap="{{canChooseTomorrow ? 'changeTab' : 'chooseInvalid'}}" 
                  data-id="{{index}}">
                明天
                <view id="{{'item' + index}}" class="fo-24"> {{ item.week }}</view>
            </view>
            <view id="{{'item' + index}}" 
                  wx:elif="{{item.day - dayNow == 2}}" 
                  class="{{active==(index) ? 'on' : ''}}" 
                  bindtap="changeTab" data-id="{{index}}">
                后天
                <view id="{{'item' + index}}" class="fo-24"> {{ item.week }}</view>
            </view>
            <view id="{{'item' + index}}" 
                  wx:else 
                  class="{{active==(index) ? 'on' : ''}}" 
                  bindtap="changeTab" data-id="{{index}}">
                {{ item.time }}
                <view class="fo-24">{{ item.week }}</view>
            </view>
        </view>
    </view>
</scroll-view>

</view>
```

```js
//创建日期数组
formatDay(num, date = new Date(new Date().getTime())) {
    let _this = this;
    let arrDay = [];
    for (let i = 0; i < num; i++) {
      let date2 = new Date(date.getTime() + 1000 * 60 * 60 * 24 * i);
      let day = date2.getDate() < 10 ? ('0' + date2.getDate()) : date2.getDate();
      console.log(day)
      arrDay.push({
        i,
        time: date2.getMonth() + 1 >= 10 ? date2.getMonth() + 1 + '-' + day : ('0' + (date2.getMonth() + 1)) + '-' + day,
        week: _this.formatWeek(date2.getDay()),
        day: day,
        year: date2.getFullYear()
      })
    }
    // console.log(arrDay)
    this.setData({
      arrDay
    })
  },
 
formatSelect: function (dayNow) {
    let currentNow = dayNow % 7 > 0 ? (dayNow % 7) - 1 : 6; //当前选择日
    let currentWeek = dayNow % 7 == 0 ? parseInt(dayNow / 7) - 1 : parseInt(dayNow / 7);
    this.setData({
      currentTime: currentNow,
      currentNow: currentNow,
      weekIndex: currentWeek,
      day: dayNow
	})
	console.log(this.data.weekIndex, currentWeek)
},
 //点击日期
  changeTab(e) {
    let index = parseInt(e.currentTarget.dataset.id);
    if (index < 0 || index > this.data.arrDay.length - 1) {
      return
    }
    console.log(e)
    this.setData({
      active: index,
      choooseDay: 'day' + index,
      appoint_time_id: '',
      appoint_time: ''
    }, () => {
      this.getTimeLine()
    })
  },

 onload:function(){
     //创建日期数组 显示后14天
     this.formatDay(14)
     
     //16：30-23：59时间段内，明日不可点击，激活后天
      if (this.checkAuditTime("16:30", "23:59")) {
      this.setData({
        active: 2, //激活tab
        choooseDay: 'day2', //所选日期
        // timeWidth:'1968',
        canChooseTomorrow: false
      })
    }
 }
//根据传入时间段判断 明日是否可点击
checkAuditTime(beginTime, endTime) {
    var nowDate = new Date();
    var beginDate = new Date(nowDate);
    var endDate = new Date(nowDate);

    var beginIndex = beginTime.lastIndexOf("\:");
    var beginHour = beginTime.substring(0, beginIndex);
    var beginMinue = beginTime.substring(beginIndex + 1, beginTime.length);
    beginDate.setHours(beginHour, beginMinue, 0, 0);

    var endIndex = endTime.lastIndexOf("\:");
    var endHour = endTime.substring(0, endIndex);
    var endMinue = endTime.substring(endIndex + 1, endTime.length);
    endDate.setHours(endHour, endMinue, 0, 0);
    if (nowDate.getTime() - beginDate.getTime() >= 0 && nowDate.getTime() <= endDate.getTime()) {
      return 1;
    } else {
      return 0;
    }
  },
```



### 小程序保存图片功能

```js
onSavePoster(e) {
    let _this = this;
    wx.showLoading({
      title: '加载中',
    });
    // 下载海报图片
    wx.downloadFile({
      url: _this.data.qrcode, //传要保存的图片url
      success(res) {
        wx.hideLoading();
        // 图片保存到本地
        wx.saveImageToPhotosAlbum({
          filePath: res.tempFilePath,
          success(data) {
            wx.showToast({
              title: '保存成功',
              icon: 'success',
              duration: 2000
            });
            // 关闭商品海报
            _this.closePopup();
          },
          fail(err) {
            console.log(err.errMsg);
            if (err.errMsg === 'saveImageToPhotosAlbum:fail auth deny') {
              wx.showToast({
                title: "请允许访问相册后重试",
                icon: "none",
                duration: 1000
              });
              setTimeout(() => {
                wx.openSetting();
              }, 1000);
            }
          },
          complete(res) {
            console.log('complete');
            // wx.hideLoading();
          }
        })
      }
    })
  },
```



### 二维码进入时，获取url上的id,显示对应的活动页

```js
/** options对象：
	path: "pages/eventDetail/eventDetail"
	query: {scene: "aid%3A10013%2Cwxapp_id%3A10001"}
	referrerInfo: {}
	scene: 1047
	shareTicket: undefined
*/
onLaunch:function(options){
    //小程序启动时调用方法获取options
    this.onStartupScene(options.query) //{scene: "aid%3A10013%2Cwxapp_id%3A10001"}
}
onStartupScene(query, callback) {
    // 格式化场景值
    let scene = this.getSceneData(query); //{aid: "10013", wxapp_id: "10001"}

    console.log(query, scene)
    log.info(query, scene, '渠道信息');
    // 记录微信小程序广告
    if (scene && scene.weixinadinfo || query.weixinadinfo) {
      // url参数中可以获取到gweixinadinfo参数值
      let weixinadinfo = scene && scene.weixinadinfo || query.weixinadinfo
      if (weixinadinfo) {
        let weixinadinfoArr = weixinadinfo.split('.')
        wx.setStorageSync('ad_id', weixinadinfoArr[0])
        wx.setStorageSync('click_id', weixinadinfoArr[1])
      }
    }
      // 6.18 新增 记录活动
      if (scene && scene.aid) {
        wx.setStorageSync('aid', scene.aid)
      }
      // 6.18 新增 wxapp_id
      if (scene && scene.wxapp_id) {
        wx.setStorageSync('wxapp_id', scene.wxapp_id)
      }
    // 记录渠道
    if (scene && scene.channel || query.channel) {
      wx.setStorageSync('channel', scene.channel || query.channel)
    }
    // 记录活动
    if (scene && scene.draw_id) {
      wx.setStorageSync('draw_id', scene.draw_id)
    }
  
    if (scene && scene.sid) {
      wx.setStorageSync('sid', scene.sid)
    }

    if (scene && scene.id) {
      this._get('wxapp/qrcodeInfo', {
        id: scene.id
      }, (res) => {
        console.log(res)
        //留资二维码主键id
        if (res.data.id) {
          wx.setStorageSync('qid', res.data.id)
        }
        // 记录活动门店
        if (res.data.sid) {
          wx.setStorageSync('sid', res.data.sid)
        }
        if (res.data.banner_image_id) {
          wx.setStorageSync('banner_image', res.data.banner.file_path)
        }
        if (res.data.channel) {
          wx.setStorageSync('channel', res.data.channel)
        }
        if (res.data.draw_id) {
          wx.setStorageSync('draw_id', res.data.draw_id)
        }
        callback && callback()
      })
    } else {
      if (wx.getStorageSync('banner_image')) {
        wx.removeStorageSync('banner_image')
      }
      callback && callback()
    }
    // 记录推荐人id
    let refereeId = query.referee_id ? query.referee_id : scene.uid;
    refereeId > 0 && this.saveRefereeId(refereeId);
  },
      
 //获取场景值
getSceneData(query) {
	return query.scene ? util.scene_decode(query.scene) : {};
},
```



### isFastClick函数

```js
//定义一个全局请求对象，包含请求时间和地址
let lastRequest = {
    lastClickTime: 0,
    lastUrl:''
}
globalData: {
    isFastClick(url,interval = 1000){
    	let time = new Date().getTime()
    	let flag = false
        //1、大于等于间隔时间 不触发
    	if(time - lastRuquest.lastCLickTime >= interval){
            flag = false
        //2、点击的不是同一个url, 不触发
        }else if(url != lastRequest.lastUrl){
            flag = false
        }else {
            flag = true
        }
        lastRequest.lastClickTime = time
        lastRequest.lasturl = url 
        return flag
	}
}

```



### getSceneData, scene_decode函数

```js
/** options对象：
	path: "pages/eventDetail/eventDetail"
	query: {scene: "aid%3A10013%2Cwxapp_id%3A10001"}
	referrerInfo: {}
	scene: 1047
	shareTicket: undefined
*/
getSceneData(query){
	return query.scene ? util.scene_decode(query.scene) : {}
}
scene_decode(e){
    if(e === undefined){
        return {}
    }
    //解码前:'aid%3A10013%2Cwxapp_id%3A10001'
    //解码后:'aid:10013,wxapp_id:10001'
    let scene = decodeURIComponent(e),
        params = scene.split(','),
        data = {};
    for(let i in params){
        let val = params[i].split(':')
        							//把val的每个key,val拿出来赋值给data对象
        val.length > 0 && val[0] && (data[val[0]] = val[1] || null)
    }
    return data
}
```





